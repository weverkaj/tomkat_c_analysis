---
title: "Gradient analysis finalized"
output: html_document
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(MASS)
library(tidyverse)
library(vegan)
library(here)
library(janitor)
library(ggpubr)
library(calecopal)
library(lubridate)
library(ggrepel)



set.seed(312)

```

#Soil Data Prep

## Read-in
```{r}
data_nut = tibble(files = list.files(here("data/soil"))) %>%
  mutate(data = map(files, ~ read_csv(here(paste("data/soil/"), .x), 
                                      col_types = cols(`Olsen P` = col_character(),
                                                       `Sodium` = col_double(),
                                                       `Total Nitrogen` = col_double(),
                                                       `pH` = col_double(),
                                                       `Sand` = col_double(),
                                                       `Silt` = col_double(),
                                                       `Clay` = col_double()
                                                       )
                                      )
                    )
         )  

data_rmn_raw = read_csv(here("data/soil/toka_soil_surveys.csv"))

```

## aggregate data
```{r}
# group data
visits_c = data_rmn_raw %>% 
  janitor::clean_names() %>% 
  group_by(point_name, date) %>% 
  select(transect_name, point_name, date, sample_number, carbon_0_10_cm, carbon_10_40_cm, clay_10_40_cm, silt_10_40_cm, sand_10_40_cm, grazed_this_year, bare_ground, litter_depth, catenal_position, starts_with("bulk"), max_depth) %>% 
  nest() %>% 
  ungroup() %>% 
  group_by(point_name) %>% 
  mutate(visit = row_number()) %>%  
  mutate(carbon_0_10 = map_dbl(data, ~ median(.x$carbon_0_10_cm)),
         carbon_10_40 = map_dbl(data, ~ median(.x$carbon_10_40_cm)),
         clay = map_dbl(data, ~ median(.x$clay_10_40_cm)),
         c_change_10 = c(NA, diff(carbon_0_10)),
         c_change_40 = c(NA, diff(carbon_10_40))) %>% 
  ungroup()

#surface points
points_c_surface = visits_c %>% 
  group_by(point_name) %>% 
  mutate(year = lubridate::year(date)) %>% 
  pivot_wider(id_cols = point_name, names_from = year, values_from = carbon_0_10) %>% 
  mutate(`2015` = na_if(`2015`, 0),
         `2018` = na_if(`2018`, 0),
         `2021` = na_if(`2021`, 0)) %>% 
  mutate(change18 = case_when(!is.na(`2015`) ~ `2018`- `2015`,
                              is.na(`2015`) ~ `2018`- `2014`),
         change21 = `2021`- `2018`,
         depth = 10,
         id = paste(point_name, depth, sep = "-"))

#deep points
points_c_depth = visits_c %>% 
  group_by(point_name) %>% 
  mutate(year = lubridate::year(date)) %>% 
  pivot_wider(id_cols = point_name, names_from = year, values_from = carbon_10_40) %>% 
  mutate(`2015` = na_if(`2015`, 0),
         `2018` = na_if(`2018`, 0),
         `2021` = na_if(`2021`, 0)) %>% 
  mutate(change18 = case_when(!is.na(`2015`) ~ `2018`- `2015`,
                              is.na(`2015`) ~ `2018`- `2014`),
         change21 = `2021`- `2018`,
         depth = 40,
         id = paste(point_name, depth, sep = "-"))

#all points
toka_c_points = bind_rows(points_c_surface, points_c_depth) %>% 
  column_to_rownames("id") %>% 
  mutate(depth = as.factor(depth)) %>% 
  mutate(depth_text = case_when(depth == 10 ~ "0-10 cm",
                           depth == 40 ~ "10-40 cm")) 

change_future = toka_c_points %>% 
  select(`2015`, `2018`, change18, change21, depth) %>% 
  rownames_to_column() %>% 
  filter(!is.na(change21)) %>% 
  column_to_rownames("rowname")

GGally::ggpairs(toka_c_points %>% select(-point_name))

```



```{r}
change10 = toka_c_points %>% 
  filter(depth == "10")

change40 = toka_c_points %>% 
  filter(depth == "40")

change10_future = change10 %>% 
  filter(!is.na(change21))

change40_future = change40 %>% 
  filter(!is.na(change21))



```

#16S data prep

## Read-in

```{r}
otu_table = read_table2(here("data/16S/table-w-taxonomy.txt"), skip = 1) %>% 
  select(-`TOKA-099-10`)
braycurtis = read_tsv(here("data/16S/braycurtis.tsv"))
jaccard = read_tsv(here("data/16S/jaccard.tsv"))
shannon = read_tsv(here("data/16S/shannon.tsv"))
```

```{r}

#full otu table

otu_straight = otu_table %>% 
  column_to_rownames("#OTU_ID") %>% 
  select(starts_with("TOKA")) %>% 
  t() %>% 
  as.data.frame() %>% 
  select_if(colSums(.) != 0)

#standardized otu table

otu_standard = decostand(otu_straight, method = "total")
```

```{r}
#key to phyla

phylum_key = otu_table %>% 
  select(`#OTU_ID`, p)

#table of phylum occurence
family_table = otu_straight %>% 
  rownames_to_column("point_id") %>% 
  pivot_longer(-point_id) %>% 
  left_join(phylum_key, by = c("name" = "#OTU_ID")) %>% 
  group_by(point_id, p) %>% 
  mutate(p = str_remove(p, ";")) %>% 
  summarise(family_count = sum(value)) %>% 
  pivot_wider(id_cols = point_id, names_from = p, values_from = family_count)

#standardized family table

family_standard = family_table %>% 
  column_to_rownames("point_id") %>% 
  decostand(method = "total")




```
#Fungal Data Prep

##Read-in


If we end up rarefying, we can use rarefy from vegan
```{r}
asv_tab_forward = read_csv(here("data/asv_tab_forward_long.csv")) #asv table
asv_tab_unite = read_csv(here("data/asv_unite_forward..csv")) #taxon assignments in same order as OTUs
asv_guilds = read_csv(here("data/asv_unite_forward_ff.guilds.csv")) %>% clean_names() #functional assignments
```

```{r}

asv_table = asv_tab_forward %>% 
  select(contains("TOKA")) %>% 
  clean_names(case = "all_caps")

colnames(asv_table) = str_replace_all(colnames(asv_table), "_", "-")

```

```{r}
asv_table_standard = asv_table %>% 
  t() %>% 
  decostand(method = "total") %>% 
  t() %>% 
  as.data.frame() %>% 
  select(-`TOKA-099-10`)

asv_table_guilds = asv_table_standard %>% 
  rownames_to_column() %>% 
  left_join(asv_guilds %>% rownames_to_column(), by = "rowname")
```

## functional summary
```{r}
fungal_func_sum = asv_table_guilds %>% 
  select(-trait, -sequence, -taxonomy, -taxon, - taxon_level, -notes, -citation_source, - rowname, - guild, -growth_morphology) %>% 
  filter(confidence_ranking %in% c("Probable", "Highly Probable")) %>% 
  select(-confidence_ranking) %>% 
  pivot_longer(-trophic_mode) %>% 
  group_by(name, trophic_mode) %>% 
  summarize(value = sum(value)) %>% 
  pivot_wider(names_from = trophic_mode, values_from = value) %>% 
  column_to_rownames("name")



fungal_guild_sum = asv_table_guilds %>% 
  select(-trait, -sequence, -taxonomy, -taxon, - taxon_level, -notes, -citation_source, - rowname, -trophic_mode, -growth_morphology) %>% 
  filter(confidence_ranking %in% c("Probable", "Highly Probable")) %>% 
  select(-confidence_ranking) %>% 
  pivot_longer(-guild) %>% 
  group_by(name, guild) %>% 
  summarize(value = sum(value)) %>% 
  pivot_wider(names_from = guild, values_from = value) %>% 
  column_to_rownames("name") %>% 
  mutate(all_saprotroph = select(., contains("Saprotroph")) %>% rowSums(),
         all_mycorrhizae = select(., contains("Mycorrhizal")) %>% rowSums(),
         all_ecto = select(., contains("Ectomycorrhizal")) %>% rowSums(),
         mycorrhizal_only = select(., contains("mycorrhizal" , ignore.case = TRUE), -contains("-")) %>% rowSums(),
         plant_pathogens = select(., contains("Plant Pathogen" , ignore.case = TRUE)) %>% rowSums(),
         saprotroph_only = select(., contains("Saprotroph"), -contains("mycorrhizal", ignore.case = TRUE), -contains("Parasite"), -contains("Pathogen"), -contains("Endophyte"), - contains("Epiphyte")) %>% rowSums()) %>% 
  select(-contains("-"))

guild_sum = colMeans(fungal_guild_sum) %>% 
  as.data.frame() %>% 
  clean_names() %>% 
  arrange(desc(x)) 



```

## Divide ASV table into depths
```{r}
asv_all = asv_table_standard %>% 
  t() %>% 
  as.data.frame() %>% 
  select(where(~ any(. != 0)))

asv_10 = asv_table_standard %>% 
  select(ends_with("-10")) %>% 
  t() %>% 
  as.data.frame() %>% 
  select(where(~ any(. != 0)))

asv_40 = asv_table_standard %>% 
  select(ends_with("-40")) %>% 
  t() %>% 
  as.data.frame() %>% 
  select(where(~ any(. != 0)))

```

# Veg data Prep

Read in data    
```{r}
lpi_raw = toka_lpi = read_csv(here("data/veg/toka_lpi.csv"))

lpi_count = lpi_raw %>% 
  janitor::clean_names() %>% 
  filter(!is.na(soil_surface)) %>% 
  group_by(point_id, date) %>% 
  count() %>% 
  mutate(year = year(date))

toka_lpi = lpi_raw %>% 
  janitor::clean_names() %>% 
  filter(!is.na(soil_surface)) %>% 
  mutate(date = lubridate::ymd(date),
         year = lubridate::year(date)) %>% 
  select(point_id, year, top_layer, starts_with("lower")) %>% 
  janitor::remove_empty() %>% 
  pivot_longer(c(top_layer, starts_with("lower")))

toka_canopy = lpi_raw %>% 
  janitor::clean_names() %>% 
  filter(!is.na(soil_surface)) %>% 
  mutate(date = lubridate::ymd(date),
         year = lubridate::year(date)) %>% 
  filter(year != "2016") %>% 
  select(point_id, point_index, direction, year, starts_with("canopy")) %>% 
  janitor::remove_empty() %>% 
  pivot_longer(c(starts_with("canopy")))

```

## Summarize lpi

```{r}

canopy_cover = toka_canopy %>% 
  filter(name == "canopy1",
         ) %>% #!is.na(value)
  group_by(point_id, year)%>% 
  summarise(n = sum(!is.na(value))) %>% 
  left_join(lpi_count, by = c("year", "point_id")) %>% 
  mutate(percent_cover = n.x/n.y) %>% 
  select(point_id, year, percent_cover)

canopy_sum = toka_canopy %>% 
  group_by(point_id, year) %>% 
  count(value) %>% 
  left_join(lpi_count, by = c("year", "point_id")) %>% 
  mutate(percent_cover = n.x/n.y) %>% 
  pivot_wider(id_cols = c(point_id, year), names_from = value, values_from = percent_cover) %>% 
  mutate_all(~ replace_na(.x, 0)) %>% 
  select(-`NA`)
  
  
lpi_sum = toka_lpi %>%   
  group_by(point_id, year) %>% 
  count(value)

com_table = lpi_sum %>% 
  pivot_wider(id_cols = c(point_id, year), names_from = value, values_from = n) %>% 
  mutate_all(~ replace_na(.x, 0)) %>% 
  select(-`NA`, -L, - WL, - NOPLANT)

load(here("data/veg/CAPlantsv2.RData"))

fungrps = CAPlantsv2 %>% 
  janitor::clean_names() %>% 
  select(symbol, fun_grp)

lpi_fun_sum = lpi_sum %>% 
  left_join(fungrps, by = c("value" = "symbol"))


lpi_fun_sum$fun_grp[lpi_fun_sum$value == "2GA"] = "Annual Grass"
lpi_fun_sum$fun_grp[lpi_fun_sum$value == "2FA"] = "Annual Forb"
lpi_fun_sum$fun_grp[lpi_fun_sum$value == "2GP"] = "Perennial Grass"

com_table_fun = lpi_fun_sum %>% 
  group_by(point_id, year, fun_grp) %>% 
  summarise(n = sum(n)) %>% 
  pivot_wider(id_cols = c(point_id, year), names_from = fun_grp, values_from = n) %>% 
  mutate_all(~ replace_na(.x, 0)) %>% 
  select(-`NA`) 


bare_ground = lpi_raw %>% 
  janitor::clean_names() %>% 
  filter(!is.na(soil_surface)) %>% 
  mutate(date = lubridate::ymd(date),
         year = lubridate::year(date)) %>% 
  filter(year != 2016,
         top_layer == "NOPLANT" & is.na(lower1),
         is.na(canopy1),
         nchar(soil_surface) < 4) %>% 
  group_by(point_id, year) %>% 
  summarise(bare_ground = n()) %>% 
  right_join(lpi_count %>% filter(year != 2016), by = c("point_id", "year")) %>% 
  mutate(bare_ground = replace_na(bare_ground, 0)) %>% 
  mutate(relative_bareground =  bare_ground/n)

```

## Separate by year and prep for depth
```{r}
data_18 = com_table %>% 
  filter(year == 2018)

data_21 = com_table %>% 
  filter(year == 2021)

data_16 = com_table %>% 
  filter(year == 2016)

data_15 = com_table %>% 
  filter(year == 2014)

points_18 = data_18$point_id

new_com_table = data_18 %>% 
  ungroup() %>% 
  mutate(id = paste(point_id, "10", sep = "-")) %>% 
  column_to_rownames("id") %>% 
  select(-point_id, -year) %>% 
  decostand(method = "total")

new_com_table10 = data_18 %>% 
  ungroup() %>% 
  mutate(id = paste(point_id, "10", sep = "-")) %>% 
  column_to_rownames("id") %>% 
  select(-point_id, -year) %>% 
  decostand(method = "total")

new_com_table40 = data_18 %>% 
  ungroup() %>% 
  mutate(id = paste(point_id, "40", sep = "-")) %>% 
  column_to_rownames("id") %>% 
  select(-point_id, -year) %>% 
  decostand(method = "total")


```




```{r}
com_change_table18 = com_table %>% 
  filter(year == 2018 | year < 2018) %>% 
  group_by(point_id) %>% 
  filter(n() > 1) %>% 
  mutate(id = paste(point_id, year, sep = "-")) %>% 
  column_to_rownames("id") %>% 
  ungroup() %>% 
  select(-point_id, - year) %>% 
  decostand(method = "total")

year_dist18 = vegdist(com_change_table18, method = "bray") %>% 
  as.matrix() %>% 
  as.data.frame() %>% 
  rownames_to_column() %>% 
  filter(str_detect(rowname, "2016")) %>% 
  column_to_rownames("rowname") %>% 
  select(contains("2018")) %>% 
  as.matrix()

veg_point_distance18 = data_frame(distance = diag(year_dist18)) %>% 
  mutate(points = rownames(year_dist18))
```
## Summarize community change

```{r}

com_change_table = com_table %>% 
  filter(year == 2018 | year == 2021) %>% 
  group_by(point_id) %>% 
  filter(n() > 1) %>% 
  mutate(id = paste(point_id, year, sep = "-")) %>% 
  column_to_rownames("id") %>% 
  ungroup() %>% 
  select(-point_id, - year) %>% 
  decostand(method = "total")

year_dist = vegdist(com_change_table, method = "bray") %>% 
  as.matrix() %>% 
  as.data.frame() %>% 
  rownames_to_column() %>% 
  filter(str_detect(rowname, "2018")) %>% 
  column_to_rownames("rowname") %>% 
  select(contains("2021")) %>% 
  as.matrix()

veg_point_distance = data_frame(distance = diag(year_dist)) %>% 
  mutate(points = rownames(year_dist))

```

```{r}
top_species = new_com_table %>% 
  rownames_to_column() %>% 
  pivot_longer(-rowname) %>% 
  group_by(name) %>% 
  summarise(total = sum(value),
            mean = mean(value),
            sd = sd(value))

write.csv(top_species, file = here("documents/figures/top_plants_table.csv"))
```

```{r}
com_table21_change = data_21 %>% 
  column_to_rownames("point_id") %>% 
  select(-year) %>% 
  decostand(method = "total")

com_table18_change = data_18 %>% 
  column_to_rownames("point_id") %>% 
  select(-year) %>% 
  decostand(method = "total") %>% 
  filter(rownames(.) %in% rownames(com_table21_change))

veg_change_com = com_table21_change - com_table18_change

````




#Bacterial Analyses

```{r}

otu_standard_match = otu_standard %>% 
  filter(rownames(.) %in% rownames(toka_c_points))

otu_standard_match10 = otu_standard %>% 
  filter(rownames(.) %in% rownames(change10)) %>% 
  as.data.frame()

otu_standard_match40 = otu_standard %>% 
  filter(rownames(.) %in% rownames(change40)) %>% 
  as.data.frame()

```


## Diversity

### calculate diversity

```{r}
microbe_diversity = diversity(otu_standard_match) %>% 
  as.data.frame() %>% 
  clean_names() %>% 
  rename(diversity = x)

microbe_richness = specnumber(otu_standard_match) %>% 
  as.data.frame() %>% 
  clean_names() %>% 
  rename(richness = x)

microbe_diversity_soil = microbe_diversity %>% 
  rownames_to_column() %>% 
  left_join(microbe_richness %>% rownames_to_column(), by = "rowname") %>% 
  left_join(toka_c_points %>% rownames_to_column(), by = "rowname")
  
richness_sum = microbe_diversity_soil %>% 
  group_by(depth) %>% 
  summarize(richness_mean = mean(richness), richness_sd = sd(richness))

microbe_diversity_soil10 = microbe_diversity_soil %>% 
  filter(depth == 10)

microbe_diversity_soil40 = microbe_diversity_soil %>% 
  filter(depth == 40)


print(richness_sum)
```

### diversity linear models
```{r}
divmod_surf = lm(`2018` ~ richness, data = microbe_diversity_soil10) # not significant <----
summary(divmod_surf)

divmod_depth = lm(`2018` ~ richness, data = microbe_diversity_soil40) #not significant
summary(divmod_depth)


divmod_surf_change = lm(change18 ~ richness, data = microbe_diversity_soil10) #not significant
summary(divmod_surf_change)

divmod_depth_change = lm(change18 ~ richness, data = microbe_diversity_soil40) #not significant
summary(divmod_depth_change)


divmod_surf_future = lm(change21 ~ richness, data = microbe_diversity_soil10) #not significant
summary(divmod_surf_future)

divmod_depth_future = lm(change21 ~ richness, data = microbe_diversity_soil40) #marginally significant
summary(divmod_depth_future)



# AIC(divmod_current, divmod_current_depth)



# AIC(divmod_current, divmod_current_int)

```


### Diversity plots
```{r}

(bact_richness = ggplot(microbe_diversity_soil, aes(x = richness, y = `2018`)) +
  geom_point() +
  facet_wrap(. ~ depth_text) +
  geom_smooth(method = "lm", linetype = "dashed", color = "black") +
  # scale_color_manual(values = c("darkgreen", "purple"),  labels = c("0-10 cm", "10-40 cm"), name = "Depth") +
  theme_bw() +
  theme(axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill="white")) +
  ylab("% SOC 2018") +
  xlab("Bacterial/Archaeal ASV Richness 2018") + 
  scale_y_continuous(labels = scales::number_format(accuracy = 0.01)))


ggsave(here::here("documents/figures/bact_richness_soc.png"), dpi = 300, plot = bact_richness, device = "png", width = 8, height = 6)

```

```{r}

(bact_richness_change = ggplot(microbe_diversity_soil, aes(x = richness, y = change21)) +
  geom_point() +
  facet_wrap(. ~ depth_text) +
  geom_smooth(data = microbe_diversity_soil40, method = "lm", linetype = "dashed", color = "black") +
  # scale_color_manual(values = c("darkgreen", "purple"), name = "Depth") +
  theme_bw() +
  theme(axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill="white")) +
  ylab("Change % SOC 2018-21") +
  xlab("2018 Bacterial/Archaeal ASV richness")+ 
  scale_y_continuous(labels = scales::number_format(accuracy = 0.1)))

ggsave(here::here("documents/figures/bact_richness_future_change.png"), dpi = 300, plot = bact_richness_change, device = "png", width = 8, height = 6)


```

## NMDS ALL


```{r}
NMS16S = metaMDS(otu_standard_match, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE, autotransform = FALSE)

```
```{r}

scores_16s = as.data.frame(scores(NMS16S))

change_mat = toka_c_points %>% 
  select(change18, `2018`, change18, change21, depth) %>% 
  filter(rownames(.) %in% rownames(scores_16s))

change_mat_complete = change_mat %>% 
  select(depth, change18, `2018`)



depth_scores = envfit(scores_16s, change_mat, nperm = 999, na.rm = T)
depth_scores_plot = as.data.frame(scores(depth_scores, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C",
                              rowname == "c_pc_change" ~ "% Carbon Change (Relative)",
                              rowname == "cn_change" ~ "C:N ratio change",
                              rowname == "n_2018" ~ "% Nitrogen",
                              rowname == "c_n_ratio" ~ "C:N ratio",
                              rowname == "change21" ~ "Future % Change",
                              rowname == "sand" | rowname == "silt" | rowname == "clay" ~ rowname))

# = data.frame(depth_scores$vectors$arrows * sqrt(depth_scores$vectors$r))

depth_scores_complete = envfit(scores_16s, change_mat_complete, nperm = 999, na.rm = T)
depth_scores_plot_complete = as.data.frame(scores(depth_scores_complete, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C",
                              rowname == "c_pc_change" ~ "% Carbon Change (Relative)",
                              rowname == "cn_change" ~ "C:N ratio change",
                              rowname == "n_2018" ~ "% Nitrogen",
                              rowname == "c_n_ratio" ~ "C:N ratio",
                              rowname == "change21" ~ "Future % Change",
                              rowname == "sand" | rowname == "silt" | rowname == "clay" ~ rowname))

fam_16_env = envfit(scores_16s, family_standard, nperm = 999, na.rm = TRUE)
fam_16_scores = as.data.frame(scores(fam_16_env, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(phylum = str_replace(rowname, "p__", ""))

scores_16s_data = as.data.frame(scores(NMS16S)) %>%
  rownames_to_column() %>% 
  left_join(change_mat_complete %>% rownames_to_column(), by = "rowname") %>% 
  mutate(depth_cm = as.factor(depth))

surface_grp = scores_16s_data[scores_16s_data$depth == 10,][chull(scores_16s_data[scores_16s_data$depth_cm == 10, c("NMDS1", "NMDS2")]),]

depth_grp = scores_16s_data[scores_16s_data$depth_cm == 40,][chull(scores_16s_data[scores_16s_data$depth_cm == 40, c("NMDS1", "NMDS2")]),]

hull_data = rbind(surface_grp, depth_grp)

NMDS.mean=aggregate(scores_16s_data[,1:2],list(group=scores_16s_data$depth_cm),mean)


veganCovEllipse<-function (cov, center = c(0, 0), scale = 1, npoints = 100) 
{
  theta <- (0:npoints) * 2 * pi/npoints
  Circle <- cbind(cos(theta), sin(theta))
  t(center + scale * t(Circle %*% chol(cov)))
}

df_ell <- data.frame()
for(g in levels(scores_16s_data$depth_cm)){
  df_ell <- rbind(df_ell, cbind(as.data.frame(with(scores_16s_data[scores_16s_data$depth_cm==g,],
                                                   veganCovEllipse(cov.wt(cbind(NMDS1,NMDS2),wt=rep(1/length(NMDS1),length(NMDS1)))$cov,center=c(mean(NMDS1),mean(NMDS2)))))
                                ,group=g))
}

```
### plot
```{r}
(bact_nmds_all = ggplot(scores_16s_data, aes(NMDS1, NMDS2)) +
  geom_point(aes(color = depth_cm), size = 4) +
  geom_path(data = df_ell, aes(x = NMDS1, y = NMDS2, color = group), size = 1, linetype = 2) +
  scale_color_manual(values = c("darkgreen", "purple"), labels = c("0-10 cm", "10-40cm"), name = "Depth") + 
  scale_fill_manual(values = c("darkgreen", "purple"), labels = c("0-10 cm", "10-40cm"), name = "Depth") +
  geom_text(data = fam_16_scores, mapping = aes(x = NMDS1, y = NMDS2, label = phylum), color = "black", size = 3) +
  geom_text(aes(label = paste("stress = ", round(NMS16S$stress, 3)), x = 0.8, y = -.9), size = 4, color = "black") +
  theme_bw() +
  xlim(-.9, 1))

ggsave(here::here("documents/figures/bact_NMDS_all.png"), dpi = 300, plot = bact_nmds_all, device = "png", width = 8, height = 6)

```
## NMDS 10

```{r}
NMDS_16S_10 = metaMDS(otu_standard_match10, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)
NMDS_16S_10
```

###envfit

```{r}
scores_16s_10 = as.data.frame(scores(NMDS_16S_10))

change10_complete = change10 %>% 
  filter(rownames(.) %in% rownames(scores_16s_10)) %>% 
  select(change18, `2018`)


depth_scores10_complete = envfit(scores_16s_10, change10_complete, nperm = 999, na.rm = T)



depth_scores_plot10_complete = as.data.frame(scores(depth_scores10_complete, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C (2018)"))


family_standard_10 = family_standard %>% 
  filter(rownames(.) %in% rownames(change10)) %>% 
  select_if(colSums(.) != 0)

fam_16_env10 = envfit(scores_16s_10, family_standard_10, nperm = 999)
fam_16_scores10 = as.data.frame(scores(fam_16_env10, display = "vectors")) %>% 
  rownames_to_column() %>% 
  left_join(as.data.frame(fam_16_env10$vectors$pvals) %>% rownames_to_column(), by = "rowname") %>% 
  mutate(phylum = str_replace(rowname, "p__", "")) %>% 
  filter(`fam_16_env10$vectors$pvals` <= 0.05)

scores_16s_10 = as.data.frame(scores(NMDS_16S_10)) %>% 
  rownames_to_column() %>% 
  left_join(change10_complete %>% rownames_to_column(), by = "rowname") 


```



### no outlier
```{r}
ff = change10 %>% 
  filter(`2018` < 7) %>% 
  filter(rownames(.) %in% rownames(otu_standard_match10)) %>% 
  select(`2018`, change18)

otu10_no_outlier = otu_standard_match10 %>% 
  filter(rownames(.) %in% rownames(ff))

family_no_outlier = family_standard_10 %>% 
  filter(rownames(.) %in% rownames(ff))

NMDS_16S_10_no = metaMDS(otu10_no_outlier, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)
NMDS_16S_10_no


```



```{r}
scores_16s_10_no = as.data.frame(scores(NMDS_16S_10_no))

depth_scores10_complete_no = envfit(scores_16s_10_no, ff, nperm = 999, na.rm = T)
depth_scores_plot10_complete_no = as.data.frame(scores(depth_scores10_complete_no, display = "vectors")) %>% 
  rownames_to_column() %>% 
   mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C (2018)",
                              rowname == "c_pc_change" ~ "% Carbon Change (Relative)",
                              rowname == "cn_change" ~ "C:N ratio change",
                              rowname == "n_2018" ~ "% Nitrogen",
                              rowname == "c_n_ratio" ~ "C:N ratio",
                              rowname == "change21" ~ "Future % Change",
                              rowname == "sand" | rowname == "silt" | rowname == "clay" ~ rowname)) %>% 
  filter(rowname %in% c( "change18", "2018" , "change21"))

family_standard_10_no = family_no_outlier%>% 
  select_if(colSums(.) != 0)

fam_16_env10_no = envfit(scores_16s_10_no, family_standard_10_no, nperm = 999)
fam_16_scores10_no = as.data.frame(scores(fam_16_env10_no, display = "vectors")) %>% 
  rownames_to_column() %>% 
  left_join(as.data.frame(fam_16_env10_no$vectors$pvals) %>% rownames_to_column(), by = "rowname") %>% 
  mutate(phylum = str_replace(rowname, "p__", "")) %>% 
  filter(`fam_16_env10_no$vectors$pvals` <= 0.05 )

scores_16s_10_no = as.data.frame(scores(NMDS_16S_10_no)) %>% 
  rownames_to_column() %>% 
  left_join(ff %>% rownames_to_column(), by = "rowname") 

```


### plots
```{r}
(plot16s_10 = ggplot(scores_16s_10, aes(NMDS1, NMDS2, color = `2018`)) +
  geom_point(size = 3) +
  geom_segment(data = depth_scores_plot10_complete, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_plot10_complete, aes(label = variable),
            size = 4, color = "black") +
  geom_text(data = fam_16_scores10, mapping = aes(x = NMDS1, y = NMDS2, label = phylum), color = "blue") +
  scale_color_viridis_c(name = "% Organic C", limits = c(2, 5), na.value = "#FDE725FF", breaks = c(2, 3, 4, 5), labels=c(2, 3, 4, ">5")) +
  geom_text(aes(label = paste("stress = ", round(NMDS_16S_10$stress, 3)), x = -0.8, y = -.6), size = 4, color = "black") + 
  theme_bw()+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill="white"))) 

```

```{r}
(plot16s_10_no = ggplot(scores_16s_10_no, aes(NMDS1, NMDS2, color = `2018`)) +
  geom_point(size = 3) +
  geom_segment(data = depth_scores_plot10_complete_no, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_plot10_complete_no, aes(label = variable),
            size = 4, color = "black") +
  geom_text(data = fam_16_scores10_no, mapping = aes(x = NMDS1, y = NMDS2, label = phylum), color = "blue") +
  scale_color_viridis_b(name = "% Organic C") +
  geom_text(aes(label = paste("stress = ", round(NMDS_16S_10_no$stress, 3)), x = -0.8, y = -.6), size = 4, color = "black") + 
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill="white")))
```
### statisic report
```{r}
depth_scores10_complete
depth_scores10_complete_no

```

## NMDS 40

```{r}

NMDS_16S_40 = metaMDS(otu_standard_match40, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)
NMDS_16S_40

```


### envfit
```{r}
scores_16s_40 = as.data.frame(scores(NMDS_16S_40))

change40_complete = change40 %>% 
  filter(rownames(.) %in% rownames(scores_16s_40)) %>% 
  select(change18, `2018`)

depth_scores40_complete = envfit(scores_16s_40, change40_complete, nperm = 999, na.rm = T)
depth_scores_plot40_complete = as.data.frame(scores(depth_scores40_complete, display = "vectors")) %>% 
  rownames_to_column() %>% 
   mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C"))

family_standard_40 = family_standard %>% 
  filter(rownames(.) %in% rownames(change40)) %>% 
  select_if(colSums(.) != 0)

fam_16_env40 = envfit(scores_16s_40, family_standard_40, nperm = 999)
fam_16_scores40 = as.data.frame(scores(fam_16_env40, display = "vectors")) %>% 
  rownames_to_column() %>% 
  left_join(as.data.frame(fam_16_env40$vectors$pvals) %>% rownames_to_column(), by = "rowname") %>% 
  mutate(phylum = str_replace(rowname, "p__", "")) %>% 
  filter(`fam_16_env40$vectors$pvals` <= 0.05)


scores_16s_40 = as.data.frame(scores(NMDS_16S_40)) %>% 
  rownames_to_column() %>%
  left_join(change40_complete %>% rownames_to_column(), by = "rowname")

```


### no outlier

```{r}

ff40 = change40_complete %>% filter(`2018` < 5)

otu40_no_outlier = otu_standard_match40 %>% 
  filter(rownames(.) %in% rownames(ff40))

family_no_outlier40 = family_standard_40 %>% 
  filter(rownames(.) %in% rownames(ff40))



NMDS_16S_40_no = metaMDS(otu40_no_outlier, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)
NMDS_16S_40_no
```


```{r}
scores_16s_40_no = as.data.frame(scores(NMDS_16S_40_no))

depth_scores40_complete_no = envfit(scores_16s_40_no, ff40, nperm = 999, na.rm = T)
depth_scores_plot40_complete_no = as.data.frame(scores(depth_scores40_complete_no, display = "vectors")) %>% 
  rownames_to_column() %>% 
   mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C (2018)"))


family_standard_40_no = family_no_outlier40%>% 
  select_if(colSums(.) != 0)

fam_16_env40_no = envfit(scores_16s_40_no, family_standard_40_no, nperm = 999)
fam_16_scores40_no = as.data.frame(scores(fam_16_env40_no, display = "vectors")) %>% 
  rownames_to_column() %>% 
  left_join(as.data.frame(fam_16_env40_no$vectors$pvals) %>% rownames_to_column(), by = "rowname") %>% 
  mutate(phylum = str_replace(rowname, "p__", "")) %>% 
  filter(`fam_16_env40_no$vectors$pvals` <= 0.05)

scores_16s_40_no = as.data.frame(scores(NMDS_16S_40_no)) %>% 
  rownames_to_column() %>% 
  left_join(ff40 %>% rownames_to_column(), by = "rowname") 
```

### plots

```{r}

(plot16s_40 = ggplot(scores_16s_40, aes(NMDS1, NMDS2, color = `2018`)) +
  geom_point(size = 3) +
  geom_segment(data = depth_scores_plot40_complete, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_plot40_complete, aes(label = variable),
            size = 4, color = "black") +
  geom_text(data = fam_16_scores40, mapping = aes(x = NMDS1, y = NMDS2, label = phylum), color = "blue") +
  scale_color_viridis_c(name = "% Organic C", limits = c(1, 3), na.value = "#FDE725FF", breaks = c(1, 2, 3), labels=c(1, 2, ">3")) + 
  geom_text(aes(label = paste("stress = ", round(NMDS_16S_40$stress, 3)), x = 0.8, y = -.7), size = 4, color = "black") + 
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill="white")) ) 


```

```{r}
(plot16s_40_no = ggplot(scores_16s_40_no, aes(NMDS1, NMDS2, color = `2018`)) +
  geom_point(size = 3) +
  geom_segment(data = depth_scores_plot40_complete_no, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_plot40_complete_no, aes(label = variable),
            size = 4, color = "black") +
  geom_text(data = fam_16_scores40_no, mapping = aes(x = NMDS1, y = NMDS2, label = phylum), color = "blue") +
  scale_color_viridis_b(name = "% Organic C")  +
  geom_text(aes(label = paste("stress = ", round(NMDS_16S_40_no$stress, 3)), x = -0.6, y = -.6), size = 4, color = "black") + 
  theme_bw()+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill="white"))) 
```

### statisic report
```{r}
depth_scores40_complete
depth_scores40_complete_no

```
## final NMDS figures

```{r}
(bact_NMDS_all = ggarrange(plot16s_10, plot16s_40, common.legend = F, legend = "right", ncol = 1, labels = "AUTO")  +
  theme(axis.title = element_text(size = 12)))

(bact_NMDS_all_no_outlier = ggarrange(plot16s_10_no, plot16s_40_no, common.legend =F, legend = "right", ncol = 1, labels = "AUTO")  +
  theme(axis.title = element_text(size = 12)))


ggsave(here::here("documents/figures/bact_NMDS_all.png"), dpi = 300, plot = bact_NMDS_all, device = "png", width = 8, height = 12)

ggsave(here::here("documents/figures/bact_NMDS_all_no_outlier.png"), dpi = 300, plot = bact_NMDS_all_no_outlier, device = "png", width = 8, height = 12)

```





##NMDS Future

### Surface

```{r}
otu_future10 = otu_standard %>% 
  filter(rownames(.) %in% rownames(change10_future))

change10_future_16 = change10_future %>% 
  filter(rownames(.) %in% rownames(otu_future10)) %>% 
  select(change21)

```


```{r}

NMDS_16S_future10 = metaMDS(otu_future10, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)

NMDS_16S_future10

```



```{r}


scores_16s_future10 = as.data.frame(scores(NMDS_16S_future10))


depth_scores_future10 = envfit(scores_16s_future10, change10_future_16, nperm = 999, na.rm = T)

depth_scores_plot_future10 = as.data.frame(scores(depth_scores_future10, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change21" ~ "Future % Change"))


scores_16s_future10 = as.data.frame(scores(NMDS_16S_future10)) %>% 
  rownames_to_column() %>% 
  left_join(change10_future_16 %>% rownames_to_column(), by = "rowname")

```

#### plot

```{r}
ggplot(scores_16s_future10, aes(NMDS1, NMDS2)) +
  geom_point(aes(color = change21), size = 4) +
  geom_segment(data = depth_scores_plot_future10, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_plot_future10, aes(x = NMDS1, y = NMDS2, label = variable),
            size = 6) +
  theme_bw()

```
#### stats
```{r}
depth_scores_future10

```

### Depth

```{r}
otu_future40 = otu_standard %>% 
  filter(rownames(.) %in% rownames(change40_future))

change40_future_16 = change40_future %>% 
  filter(rownames(.) %in% rownames(otu_future40)) %>% 
  select(change21)

```


```{r}

NMDS_16S_future40 = metaMDS(otu_future40, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)

NMDS_16S_future40

```



```{r}


scores_16s_future40 = as.data.frame(scores(NMDS_16S_future40))


depth_scores_future40 = envfit(scores_16s_future40, change40_future_16, nperm = 999, na.rm = T)

depth_scores_plot_future40 = as.data.frame(scores(depth_scores_future40, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change21" ~ "Future % Change"))


scores_16s_future40 = as.data.frame(scores(NMDS_16S_future40)) %>% 
  rownames_to_column() %>% 
  left_join(change40_future_16 %>% rownames_to_column(), by = "rowname")

```

#### plot

```{r}
ggplot(scores_16s_future40, aes(NMDS1, NMDS2)) +
  geom_point(aes(color = change21), size = 4) +
  geom_segment(data = depth_scores_plot_future40, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_plot_future40, aes(x = NMDS1, y = NMDS2, label = variable),
            size = 6) +
  theme_bw()

```

#### stats
```{r}
depth_scores_future40

```
## Taxonomic Composition
```{r}

depth_key = toka_c_points %>% 
  select(depth) %>% 
  rownames_to_column %>% 
  mutate(depth_text = case_when(depth == 10 ~ "0-10 cm",
                           depth == 40 ~ "10-40 cm"))

fam_carbon_10 = family_standard_10 %>% 
  rownames_to_column() %>% 
  left_join(toka_c_points %>% select(`2018`, change18, change21) %>% rownames_to_column(), by = "rowname") %>% 
  column_to_rownames("rowname")


fam_carbon_40 = family_standard_40 %>% 
  rownames_to_column() %>% 
  left_join(toka_c_points %>% select(`2018`, change18, change21) %>% rownames_to_column(), by = "rowname") %>% 
  column_to_rownames("rowname")

fam_carbon = family_standard %>% 
  rownames_to_column() %>% 
  left_join(toka_c_points %>% select(`2018`, change18, change21) %>% rownames_to_column(), by = "rowname") %>% 
  left_join(depth_key, by = "rowname") %>% 
  column_to_rownames("rowname")

fam_pivot_10 = family_standard_10 %>% 
  select_if(colSums(.) != 0) %>%
  rownames_to_column() %>%
  pivot_longer(-rowname)

bottom_taxa = family_standard %>% 
  select(-p__Verrucomicrobia, -p__Acidobacteria, -p__Proteobacteria, -p__Bacteroidetes, -p__Planctomycetes, -p__Actinobacteria, -p__Gemmatimonadetes, -p__Firmicutes, -p__Chloroflexi) %>% 
  mutate(other = rowSums(.)) %>% 
  rownames_to_column() %>% 
  select(rowname, other)

top_taxa = family_standard %>% 
  select(p__Verrucomicrobia, p__Acidobacteria, p__Proteobacteria, p__Bacteroidetes, p__Planctomycetes, p__Actinobacteria, p__Gemmatimonadetes, p__Firmicutes, p__Chloroflexi) %>% 
  rownames_to_column() %>% 
  left_join(bottom_taxa, by = "rowname")

top_taxa_3 = family_standard %>% 
  select(p__Verrucomicrobia, p__Acidobacteria, p__Proteobacteria, p__Bacteroidetes,  p__Actinobacteria,  p__Gemmatimonadetes) %>% 
  mutate(total = rowSums(.))
  

top_taxa_pivot = top_taxa %>%
  left_join(depth_key, by = "rowname")%>% 
  mutate(point_id = substr(rowname, 1, nchar(rowname)-3))%>% 
  select(-rowname) %>% 
  pivot_longer(c(-point_id, -depth, - depth_text))%>% 
  mutate(phylum = factor(str_replace(name, "p__", ""), levels = rev(c("Verrucomicrobia", "Acidobacteria", "Proteobacteria", "Bacteroidetes", "Planctomycetes", "Actinobacteria", "Gemmatimonadetes", "Firmicutes", "Chloroflexi", "other")) ))


```

### Plot
```{r}
library(calecopal)

top_taxa_pivot_10 = top_taxa_pivot %>% 
  filter(depth == 10)

top_taxa_pivot_40 = top_taxa_pivot %>% 
  filter(depth == 40)

ggplot(top_taxa_pivot, aes(x = point_id, y = value, fill = phylum)) +
  geom_col() +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill="white")) +
  facet_grid(depth_text ~ .) +
  scale_fill_manual(name = "Phylum", values = rev(cal_palette("superbloom3", n = 10, type = "continuous"))) +
  xlab("Sample Point") +
  ylab("Relative Abundance")


```


## Functional Groups

Sort into functional groups
```{r}

oligotroph = c("Verrucomicrobia", "Acidobacteria")
copiotroph = c("Proteobacteria", "Bacteroidetes", "Actinobacteria", "Gemmatimonadetes")

fam_carbon_function = fam_carbon %>% 
  mutate(oligotrophs = p__Verrucomicrobia + p__Acidobacteria,
         copiotrophs = p__Proteobacteria + p__Bacteroidetes + p__Actinobacteria + p__Gemmatimonadetes,
         c_o_ratio = copiotrophs/oligotrophs,
         total_classified = oligotrophs + copiotrophs)

fam_carbon_function10 = fam_carbon_function %>% 
  filter(depth == 10)

fam_carbon_function40 = fam_carbon_function %>% 
  filter(depth == 40)

trait_sum =  fam_carbon_function %>% 
  group_by(depth) %>% 
  summarize(mean_c_o = mean(c_o_ratio),
            sd_c_o = sd(c_o_ratio),
            mean_C = mean(`2018`),
            mean_class = mean(total_classified),
            max_class = max(total_classified),
            min_class = min(total_classified))

trait_sum

```


### statistics

#### Current SOC Regressions
```{r}


trait_mod10 = lm(`2018` ~ c_o_ratio, data = fam_carbon_function10)
summary(trait_mod10)

trait_mod10_no = lm(`2018` ~ c_o_ratio, data = fam_carbon_function10 %>% filter(`2018` < 7))
summary(trait_mod10_no)

trait_mod40 = lm(`2018` ~ c_o_ratio, data = fam_carbon_function40)
summary(trait_mod40)

trait_mod40_no = lm(`2018` ~ c_o_ratio, data = fam_carbon_function40 %>% filter(`2018` < 5))
summary(trait_mod40_no)

# trait_mod = lm(log(`2018`) ~  c_o_ratio*depth_cm, data = fam_carbon_function)

# trait_mod1 = lm(log(`2018`) ~  c_o_ratio*depth_cm, data = fam_carbon_function, weights = fam_carbon_function$copiotrophs + fam_carbon_function$oligotrophs)
# summary(trait_mod)


# plot(trait_mod10_no)

```

#### Recent changes
```{r}

trait_mod10 = lm(change18 ~ c_o_ratio, data = fam_carbon_function10)
summary(trait_mod10)


trait_mod40 = lm(change18 ~ c_o_ratio, data = fam_carbon_function40)
summary(trait_mod40)


```

#### Future changes
```{r}

trait_mod10 = lm(change21 ~ c_o_ratio, data = fam_carbon_function10)
summary(trait_mod10)


trait_mod40 = lm(change21 ~ c_o_ratio, data = fam_carbon_function40)
summary(trait_mod40)


```
### plots

```{r}
(function_16S_plot = ggplot(fam_carbon_function, (aes(x = c_o_ratio, y = `2018`))) +
  geom_point() +
  theme_bw() +
  facet_grid(. ~ depth_text) +
  scale_color_manual(values = c("darkgreen", "purple"), name = "Depth") +
  theme(axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill="white")) +
  # geom_smooth(data = fam_carbon_function %>% filter(depth_cm == "0 to 10"), method = "lm", fill = "darkgreen", alpha = 0.1) +
  geom_smooth(method = "lm", color = "black", linetype = "dashed") +
  ylab("% Organic Carbon 2018") +
  xlab("2018 Copiotroph:Oligotroph Ratio")+ 
  scale_y_continuous(labels = scales::number_format(accuracy = 0.01)))

ggsave(here::here("documents/figures/bact_function_2018.png"), dpi = 300, plot = function_16S_plot, device = "png", width = 8, height = 6)




```

```{r}
(function_16S_plot_future = ggplot(fam_carbon_function, (aes(x = c_o_ratio, y = change21))) +
  geom_point() +
  theme_bw() +
  facet_grid(. ~ depth_text) +
  scale_color_manual(values = c("darkgreen", "purple"), name = "Depth") +
  theme(axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill="white")) +
  # geom_smooth(data = fam_carbon_function %>% filter(depth_cm == "0 to 10"), method = "lm", fill = "darkgreen", alpha = 0.1) +
  geom_smooth(method = "lm", color = "black", linetype = "dashed") +
  ylab("Change % Organic Carbon 2018-21") +
  xlab("2018 Copiotroph:Oligotroph Ratio") + 
  scale_y_continuous(labels = scales::number_format(accuracy = 0.1)))


ggsave(here::here("documents/figures/bact_function_future.png"), dpi = 300, plot = function_16S_plot_future, device = "png", width = 8, height = 6)

```

```{r}
(function_16S_plot_recent = ggplot(fam_carbon_function, (aes(x = c_o_ratio, y = change18))) +
  geom_point() +
  theme_bw() +
  facet_grid(. ~ depth_text) +
  scale_color_manual(values = c("darkgreen", "purple"), name = "Depth") +
  theme(axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill="white")) +
  # geom_smooth(data = fam_carbon_function %>% filter(depth_cm == "0 to 10"), method = "lm", fill = "darkgreen", alpha = 0.1) +
  geom_smooth(method = "lm", color = "black", linetype = "dashed") +
  ylab("Change % Organic Carbon 2018-2021") +
  xlab("Copiotroph:Oligotroph Ratio") + 
  scale_y_continuous(labels = scales::number_format(accuracy = 0.01)))


```


## Combined plot

```{r}
(plot_bact_all = ggarrange(function_16S_plot, function_16S_plot_future, bact_richness_change, nrow = 3, labels = "AUTO", label.x = 0.00, label.y = 1)
)
ggsave(here::here("documents/figures/16S_metrics_all.png"), dpi = 300, plot = plot_bact_all, device = "png", width = 10, height = 12)

```


# Fungal Analyses


## Diversity
```{r}

fungal_diversity = diversity(asv_all) %>% 
  as.data.frame() %>% 
  clean_names() %>% 
  rename(diversity = x)

fungal_richness = specnumber(asv_all) %>% 
  as.data.frame() %>% 
  clean_names() %>% 
  rename(richness = x)

fungal_diversity_soil = fungal_diversity %>% 
  rownames_to_column() %>% 
  left_join(fungal_richness %>% rownames_to_column(), by = "rowname") %>% 
  left_join(toka_c_points %>% rownames_to_column(), by = "rowname")

fungal_richness_sum = fungal_diversity_soil %>% 
  group_by(depth) %>% 
  summarize(richness_mean = mean(richness, na.rm = T), richness_sd = sd(richness, na.rm = T))

fungal_diversity_soil10 = fungal_diversity_soil %>% 
  filter(depth == 10)

fungal_diversity_soil40 = fungal_diversity_soil %>% 
  filter(depth == 40)


print(fungal_richness_sum)
```



```{r}

fung_surf_current = lm(`2018` ~ richness, data = fungal_diversity_soil10)
summary(fung_surf_current)

fung_surf_current_no = lm(`2018` ~ richness, data = fungal_diversity_soil10 %>% filter(`2018` < 7))
summary(fung_surf_current_no)

fung_depth_current = lm(`2018` ~ richness, data = fungal_diversity_soil40)
summary(fung_depth_current)

fung_surf_recent = lm(change18 ~ richness, data = fungal_diversity_soil10)
summary(fung_surf_recent)

fung_depth_recent = lm(change18 ~ richness, data = fungal_diversity_soil40)
summary(fung_depth_recent)

fung_surf_future = lm(change21 ~ richness, data = fungal_diversity_soil10)
summary(fung_surf_future)

fung_depth_future = lm(change21 ~ richness, data = fungal_diversity_soil40)
summary(fung_depth_future)

ggplot(fungal_diversity_soil40, aes(x = richness, y = change18)) +
  geom_point() +
  geom_smooth(method = "lm")

```
```{r}
  plot(fung_surf_current_no)
```
### plot
```{r}

(fung_richness = ggplot(fungal_diversity_soil, aes(x = richness, y = `2018`)) +
  geom_point() +
    theme_bw() +
  facet_wrap(. ~ depth_text) +
  geom_smooth(data = fungal_diversity_soil10, method = "lm", linetype = "dashed", color = "black") +
  # scale_color_manual(values = c("darkgreen", "purple"),  labels = c("0-10 cm", "10-40 cm"), name = "Depth") +
  theme(axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill="white")) +
  ylab("% SOC 2018") +
  xlab("Fungal ASV Richness 2018") + 
  scale_y_continuous(labels = scales::number_format(accuracy = 0.01)))

ggsave(here::here("documents/figures/fungal_diversity_2018.png"), dpi = 300, plot = fung_richness, device = "png", width = 8, height = 6)


```




```{r}

(fung_richness_recent = ggplot(fungal_diversity_soil, aes(x = richness, y = change18)) +
  geom_point() +
  theme_bw() +
  facet_wrap(. ~ depth_text) +
  geom_smooth(data = fungal_diversity_soil40, method = "lm", linetype = "dashed", color = "black") +
  # scale_color_manual(values = c("darkgreen", "purple"),  labels = c("0-10 cm", "10-40 cm"), name = "Depth") +
  theme(axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill="white")) +
  ylab("Change % SOC 2015-18") +
  xlab("Fungal ASV Richness 2018"))
```


## NMDS ALL

```{r}
NMDS_fungal_all = metaMDS(asv_all, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE, autotransform = FALSE)

NMDS_fungal_all


```

```{r}

scores_fungal_all = as.data.frame(scores(NMDS_fungal_all))


depth_scores_fungus = envfit(scores_fungal_all, change_mat, nperm = 999, na.rm = T)
depth_scores_fungus_plot = as.data.frame(scores(depth_scores_fungus, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C",
                              rowname == "change21" ~ "Future % Change"))

depth_scores_fungus_complete = envfit(scores_fungal_all, change_mat_complete, nperm = 999, na.rm = T)


depth_scores_fungus_plot_complete = as.data.frame(scores(depth_scores_complete, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C",
                              rowname == "c_pc_change" ~ "% Carbon Change (Relative)",
                              rowname == "cn_change" ~ "C:N ratio change",
                              rowname == "n_2018" ~ "% Nitrogen",
                              rowname == "c_n_ratio" ~ "C:N ratio",
                              rowname == "change21" ~ "Future % Change",
                              rowname == "sand" | rowname == "silt" | rowname == "clay" ~ rowname))

function_fung = envfit(scores_fungal_all, fungal_func_sum, nperm = 999, na.rm = TRUE)
fung_function_scores = as.data.frame(scores(function_fung, display = "vectors")) %>% 
  rownames_to_column()

scores_fungal_all = as.data.frame(scores(NMDS_fungal_all)) %>% 
  rownames_to_column() %>% 
  left_join(change_mat_complete %>% rownames_to_column(), by = "rowname") %>% 
  mutate(depth_cm = as.factor(depth))

surface_grp_fung = scores_fungal_all[scores_fungal_all$depth == 10,][chull(scores_fungal_all[scores_fungal_all$depth_cm == 10, c("NMDS1", "NMDS2")]),]

depth_grp_fung = scores_fungal_all[scores_fungal_all$depth_cm == 40,][chull(scores_fungal_all[scores_fungal_all$depth_cm == 40, c("NMDS1", "NMDS2")]),]

hull_data = rbind(surface_grp_fung, depth_grp_fung)

NMDS.mean_fung = aggregate(scores_fungal_all[,1:2],list(group=scores_fungal_all$depth_cm),mean)


veganCovEllipse<-function (cov, center = c(0, 0), scale = 1, npoints = 100) 
{
  theta <- (0:npoints) * 2 * pi/npoints
  Circle <- cbind(cos(theta), sin(theta))
  t(center + scale * t(Circle %*% chol(cov)))
}

df_ell_fung <- data.frame()
for(g in levels(scores_fungal_all$depth_cm)){
  df_ell_fung <- rbind(df_ell_fung, cbind(as.data.frame(with(scores_fungal_all[scores_fungal_all$depth_cm==g,],
                                                   veganCovEllipse(cov.wt(cbind(NMDS1,NMDS2),wt=rep(1/length(NMDS1),length(NMDS1)))$cov,center=c(mean(NMDS1),mean(NMDS2)))))
                                ,group=g))
}

```

### plot

```{r}
ggplot(scores_fungal_all, aes(NMDS1, NMDS2)) +
  geom_point(aes(color = depth_cm), size = 4) +
  geom_path(data = df_ell_fung, aes(x = NMDS1, y = NMDS2, color = group), size = 1, linetype = 2) +
  scale_color_manual(values = c("darkgreen", "purple"), labels = c("0-10 cm", "10-40cm"), name = "Depth") + 
  scale_fill_manual(values = c("darkgreen", "purple"), labels = c("0-10 cm", "10-40cm"), name = "Depth") +
  geom_text(data = fung_function_scores, mapping = aes(x = NMDS1, y = NMDS2, label = rowname), color = "black", size = 3) +
  geom_text(aes(label = paste("stress = ", round(NMDS_fungal_all$stress, 3)), x = 0.4, y = -.4), size = 4, color = "black") +
  theme_bw()

```

## NMDS 10

```{r}
NMDS_fungal_10 = metaMDS(asv_10, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)
NMDS_fungal_10
```
### envfit



```{r}
scores_fungal_10 = as.data.frame(scores(NMDS_fungal_10))

depth_scores_fungal10_complete = envfit(scores_fungal_10, change10_complete, nperm = 999, na.rm = T)

depth_scores_fungal_plot10_complete = as.data.frame(scores(depth_scores_fungal10_complete, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C (2018)"))

fung_sp_scores = scores(NMDS_fungal_10, display = "species") %>% 
  as.data.frame()


fungal_func10 = fungal_func_sum %>% 
  filter(rownames(.) %in% rownames(scores_fungal_10))

fung_function10 = envfit(scores_fungal_10, fungal_func10, nperm = 999, na.rm = TRUE)

fung_function_scores10 = as.data.frame(scores(fung_function10, display = "vectors")) %>% 
  rownames_to_column() %>% 
  left_join(as.data.frame(fung_function10$vectors$pvals) %>% rownames_to_column(), by = "rowname") %>%
  filter(`fung_function10$vectors$pvals` <= .1 )

scores_fungal_10 = as.data.frame(scores(NMDS_fungal_10)) %>% 
  rownames_to_column() %>% 
  left_join(change10_complete %>% rownames_to_column(), by = "rowname") 


```



### no outlier

```{r}
asv_10_no = asv_10 %>% 
  filter(rownames(.) %in% rownames(ff))

NMDS_fungal_10_no = metaMDS(asv_10_no, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)
NMDS_fungal_10
```

```{r}
scores_fungal_10_no = as.data.frame(scores(NMDS_fungal_10_no))

depth_scores_fungal10_complete_no = envfit(scores_fungal_10_no, ff, nperm = 999, na.rm = T)

depth_scores_fungal_plot10_complete_no = as.data.frame(scores(depth_scores_fungal10_complete_no, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C (2018)"))


fungal_func10_no = fungal_func_sum %>% 
  filter(rownames(.) %in% rownames(scores_fungal_10_no))

fung_function10_no = envfit(scores_fungal_10_no, fungal_func10_no, nperm = 999, na.rm = TRUE)

fung_function_scores10_no = as.data.frame(scores(fung_function10_no, display = "vectors")) %>% 
  rownames_to_column() %>% 
  left_join(as.data.frame(fung_function10_no$vectors$pvals) %>% rownames_to_column(), by = "rowname") %>%
  filter(`fung_function10_no$vectors$pvals` <= .1 )

scores_fungal_10_no = as.data.frame(scores(NMDS_fungal_10_no)) %>% 
  rownames_to_column() %>% 
  left_join(ff %>% rownames_to_column(), by = "rowname") 


```

### plots

```{r}
(fung_plot10 = ggplot(scores_fungal_10, aes(NMDS1, NMDS2, color = `2018`)) +
  geom_point(size = 3) +
  geom_segment(data = depth_scores_fungal_plot10_complete, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_fungal_plot10_complete, aes(label = variable),
            size = 4, color = "black") +
  # geom_text(data = fung_function_scores10, mapping = aes(x = NMDS1, y = NMDS2, label = rowname), color = "blue") +
  scale_color_viridis_c(name = "% Organic C", limits = c(2, 5), na.value = "#FDE725FF", breaks = c(2, 3, 4, 5), labels=c(2, 3, 4, ">5")) +
  geom_text(aes(label = paste("stress = ", round(NMDS_fungal_10$stress, 3)), x = -0.4, y = -.6), size = 4, color = "black") +
  theme_bw())

```
```{r}
(fung_plot10_no = ggplot(scores_fungal_10_no, aes(NMDS1, NMDS2, color = `2018`)) +
  geom_point(size = 3) +
  geom_segment(data = depth_scores_fungal_plot10_complete_no, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_fungal_plot10_complete_no, aes(label = variable),
            size = 4, color = "black") +
  # geom_text(data = fung_function_scores10, mapping = aes(x = NMDS1, y = NMDS2, label = rowname), color = "blue") +
  scale_color_viridis_b(name = "% Organic C") +
  geom_text(aes(label = paste("stress = ", round(NMDS_fungal_10_no$stress, 3)), x = -0.4, y = -.6), size = 4, color = "black") +
  theme_bw())
```
### statistic report
```{r}
depth_scores_fungal10_complete
depth_scores_fungal10_complete_no

```
## NMDS 40

```{r}
NMDS_fungal_40 = metaMDS(asv_40, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)
NMDS_fungal_40
```


### envfit



```{r}

scores_fungal_40 = as.data.frame(scores(NMDS_fungal_40))

depth_scores_fungal40_complete = envfit(scores_fungal_40, change40_complete, nperm = 999, na.rm = T)

depth_scores_fungal_plot40_complete = as.data.frame(scores(depth_scores_fungal40_complete, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C (2018)"))


fungal_func40 = fungal_func_sum %>% 
  filter(rownames(.) %in% rownames(scores_fungal_40))

fung_function40 = envfit(scores_fungal_40, fungal_func40, nperm = 999, na.rm = TRUE)

fung_function_scores40 = as.data.frame(scores(fung_function40, display = "vectors")) %>% 
  rownames_to_column() %>% 
  left_join(as.data.frame(fung_function40$vectors$pvals) %>% rownames_to_column(), by = "rowname") %>%
  filter(`fung_function40$vectors$pvals` <= .1 )

scores_fungal_40 = as.data.frame(scores(NMDS_fungal_40)) %>% 
  rownames_to_column() %>% 
  left_join(change40_complete %>% rownames_to_column(), by = "rowname") 


```

### no outlier

```{r}
asv_40_no = asv_40 %>% 
  filter(rownames(.) %in% rownames(ff40))

NMDS_fungal_40_no = metaMDS(asv_40_no, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)
NMDS_fungal_40
```

```{r}
scores_fungal_40_no = as.data.frame(scores(NMDS_fungal_40_no))

depth_scores_fungal40_complete_no = envfit(scores_fungal_40_no, ff40, nperm = 999, na.rm = T)

depth_scores_fungal_plot40_complete_no = as.data.frame(scores(depth_scores_fungal40_complete_no, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C (2018)"))


fungal_func40_no = fungal_func_sum %>% 
  filter(rownames(.) %in% rownames(scores_fungal_40_no))

fung_function40_no = envfit(scores_fungal_40_no, fungal_func40_no, nperm = 999, na.rm = TRUE)

fung_function_scores40_no = as.data.frame(scores(fung_function40_no, display = "vectors")) %>% 
  rownames_to_column() %>% 
  left_join(as.data.frame(fung_function40_no$vectors$pvals) %>% rownames_to_column(), by = "rowname") %>%
  filter(`fung_function40_no$vectors$pvals` <= .1 )

scores_fungal_40_no = as.data.frame(scores(NMDS_fungal_40_no)) %>% 
  rownames_to_column() %>% 
  left_join(ff40 %>% rownames_to_column(), by = "rowname") 


```


### plots
```{r}
(fung_plot40 = ggplot(scores_fungal_40, aes(NMDS1, NMDS2, color = `2018`)) +
  geom_point(size = 3) +
  geom_segment(data = depth_scores_fungal_plot40_complete, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_fungal_plot40_complete, aes(label = variable),
            size = 4, color = "black") +
  # geom_text(data = fung_function_scores40, mapping = aes(x = NMDS1, y = NMDS2, label = rowname), color = "blue") +
  scale_color_viridis_c(name = "% Organic C", limits = c(1, 3), na.value = "#FDE725FF", breaks = c(1, 2, 3), labels=c(1, 2, ">3")) + 
  geom_text(aes(label = paste("stress = ", round(NMDS_fungal_40$stress, 3)), x = -0.2, y = -.3), size = 4, color = "black") +
  theme_bw())

```

```{r}
(fung_plot40_no = ggplot(scores_fungal_40_no, aes(NMDS1, NMDS2, color = `2018`)) +
  geom_point(size = 3) +
  geom_segment(data = depth_scores_fungal_plot40_complete_no, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_fungal_plot40_complete_no, aes(label = variable),
            size = 4, color = "black") +
  # geom_text(data = fung_function_scores40, mapping = aes(x = NMDS1, y = NMDS2, label = rowname), color = "blue") +
  scale_color_viridis_b(name = "% Organic C") +
  geom_text(aes(label = paste("stress = ", round(NMDS_fungal_40_no$stress, 3)), x = -0.4, y = -.6), size = 4, color = "black") +
  theme_bw())
```


### statisic report

```{r}
depth_scores_fungal40_complete
depth_scores_fungal40_complete_no

```


## final NMDS figures

```{r}
(fung_NMDS_all = ggarrange(fung_plot10, fung_plot40, common.legend = F, legend = "right", ncol = 1, labels = "AUTO")  +
  theme(axis.title = element_text(size = 12)))

(fung_NMDS_all_no_outlier = ggarrange(fung_plot10_no, fung_plot40_no, common.legend =F, legend = "right", ncol = 1, labels = "AUTO")  +
  theme(axis.title = element_text(size = 12)))


ggsave(here::here("documents/figures/fung_NMDS_all.png"), dpi = 300, plot = fung_NMDS_all, device = "png", width = 8, height = 12)

ggsave(here::here("documents/figures/fung_NMDS_all_no_outlier.png"), dpi = 300, plot = fung_NMDS_all_no_outlier, device = "png", width = 8, height = 12)

```


##NMDS Future

### Surface

```{r}
asv_future10 = asv_10 %>% 
  filter(rownames(.) %in% rownames(change10_future))

change10_future_fung = change10_future %>% 
  filter(rownames(.) %in% rownames(asv_future10)) %>% 
  select(change21)

```


```{r}

NMDS_fungus_future10 = metaMDS(asv_future10, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)

NMDS_fungus_future10

```

```{r}


scores_fungus_future10 = as.data.frame(scores(NMDS_fungus_future10))


depth_scores_fungus_future10 = envfit(scores_fungus_future10, change10_future_16, nperm = 999, na.rm = T)

depth_scores_plot_fungus_future10 = as.data.frame(scores(depth_scores_fungus_future10, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change21" ~ "Future % Change"))


scores_fungus_future10 = as.data.frame(scores(NMDS_fungus_future10)) %>% 
  rownames_to_column() %>% 
  left_join(change10_future_16 %>% rownames_to_column(), by = "rowname")

```

#### plot

```{r}
ggplot(scores_fungus_future10, aes(NMDS1, NMDS2)) +
  geom_point(aes(color = change21), size = 4) +
  geom_segment(data = depth_scores_plot_fungus_future10, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_plot_fungus_future10, aes(x = NMDS1, y = NMDS2, label = variable),
            size = 6) +
  theme_bw()

```

####stats

```{r}
depth_scores_fungus_future10

```

### Depth


```{r}
asv_future40 = asv_40 %>% 
  filter(rownames(.) %in% rownames(change40_future))

change40_future_fung = change40_future %>% 
  filter(rownames(.) %in% rownames(asv_future40)) %>% 
  select(change21)

```


```{r}

NMDS_fungus_future40 = metaMDS(asv_future40, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)

NMDS_fungus_future40

```

```{r}


scores_fungus_future40 = as.data.frame(scores(NMDS_fungus_future40))


depth_scores_fungus_future40 = envfit(scores_fungus_future40, change40_future_16, nperm = 999, na.rm = T)

depth_scores_plot_fungus_future40 = as.data.frame(scores(depth_scores_fungus_future40, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change21" ~ "Future % Change"))


scores_fungus_future40 = as.data.frame(scores(NMDS_fungus_future40)) %>% 
  rownames_to_column() %>% 
  left_join(change40_future_16 %>% rownames_to_column(), by = "rowname")

```

#### plot

```{r}
ggplot(scores_fungus_future40, aes(NMDS1, NMDS2)) +
  geom_point(aes(color = change21), size = 4) +
  geom_segment(data = depth_scores_plot_fungus_future40, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_plot_fungus_future40, aes(x = NMDS1, y = NMDS2, label = variable),
            size = 6) +
  theme_bw()

```

#### stats

```{r}
depth_scores_fungus_future40

```

## Functional Groups

###trophic mode

```{r}

## connect functional group composition to carbon data for analysis


fung_carbon = fungal_func_sum %>% 
  rownames_to_column() %>% 
  clean_names() %>% 
  left_join(toka_c_points %>% select(`2018`, change18, change21, depth, depth_text) %>% rownames_to_column(), by = "rowname") %>% 
  column_to_rownames("rowname") %>% 
  mutate(negative = pathotroph + saprotroph + pathotroph_saprotroph)


fung_carbon_10 = fungal_func10 %>% 
  rownames_to_column() %>% 
  clean_names() %>% 
  left_join(toka_c_points %>% select(`2018`, change18, change21) %>% rownames_to_column(), by = "rowname") %>% 
  column_to_rownames("rowname") %>% 
  mutate(negative = pathotroph + saprotroph + pathotroph_saprotroph)


fung_carbon_40 = fungal_func40 %>% 
  rownames_to_column() %>% 
  clean_names() %>% 
  left_join(toka_c_points %>% select(`2018`, change18, change21) %>% rownames_to_column(), by = "rowname") %>% 
  column_to_rownames("rowname") %>% 
  mutate(negative = pathotroph + saprotroph + pathotroph_saprotroph)

functional_totals = rowSums(fungal_func_sum) %>% 
  as.data.frame() %>% 
  clean_names() %>% 
  summarise(mean = mean(x), min = min(x), max = max(x))

trophic_averages = colMeans(fungal_func_sum) %>% 
  as.data.frame()

```

### Guild

```{r}

guild_carbon = fungal_guild_sum %>% 
  rownames_to_column() %>% 
  clean_names() %>% 
  left_join(toka_c_points %>% select(`2018`, change18, change21, depth, depth_text) %>% rownames_to_column(), by = "rowname") %>% 
  column_to_rownames("rowname")

guild_carbon10 = guild_carbon %>% 
  filter(rownames(.) %in% rownames(fung_carbon_10))

guild_carbon40 = guild_carbon %>% 
  filter(rownames(.) %in% rownames(fung_carbon_40))

guild_sum = guild_carbon %>% 
  mutate(guild_total = mycorrhizal_only + saprotroph_only) %>% 
  group_by(depth) %>% 
  summarise(guild_mean = mean(guild_total), guild_sd = sd(guild_total), myc_mean = mean(mycorrhizal_only), myc_sd = sd(mycorrhizal_only), sap_sum = mean(saprotroph_only), sap_sd = sd(saprotroph_only))


guild_sum
  
  
```



### models Surface


#### saptrotroph_only
```{r}
surface_saprotroph_only_current = lm(`2018` ~ saprotroph_only, data = guild_carbon10)
summary(surface_saprotroph_only_current)

surface_saprotroph_only_recent = lm(change18 ~ saprotroph_only, data = guild_carbon10)
summary(surface_saprotroph_only_recent)

surface_saprotroph_only_future = lm(change21 ~ saprotroph_only, data = guild_carbon10)
summary(surface_saprotroph_only_future) ###

plot(surface_saprotroph_only_future)
```

#### all_saprotroph

```{r}
surface_all_saprotroph_current = lm(`2018` ~ all_saprotroph, data = guild_carbon10)
summary(surface_all_saprotroph_current)

surface_all_saprotroph_recent = lm(change18 ~ all_saprotroph, data = guild_carbon10)
summary(surface_all_saprotroph_recent)

surface_all_saprotroph_future = lm(change21 ~ all_saprotroph, data = guild_carbon10)
summary(surface_all_saprotroph_future) ###
```

#### all_mycorrhizae
```{r}
surface_all_mycorrhizae_current = lm(`2018` ~ all_mycorrhizae, data = guild_carbon10)
summary(surface_all_mycorrhizae_current)

surface_all_mycorrhizae_recent = lm(change18 ~ all_mycorrhizae, data = guild_carbon10)
summary(surface_all_mycorrhizae_recent)

surface_all_mycorrhizae_future = lm(change21 ~ all_mycorrhizae, data = guild_carbon10)
summary(surface_all_mycorrhizae_future)
```


#### mycorrhizae_only
```{r}
surface_mycorrhizal_only_current = lm(`2018` ~ mycorrhizal_only, data = guild_carbon10)
summary(surface_mycorrhizal_only_current)

surface_mycorrhizal_only_recent = lm(change18 ~ mycorrhizal_only, data = guild_carbon10)
summary(surface_mycorrhizal_only_recent)

surface_mycorrhizal_only_future = lm(change21 ~ mycorrhizal_only, data = guild_carbon10)
summary(surface_mycorrhizal_only_future) ###


```


#### plant_pathogens
```{r}
surface_plant_pathogen_current = lm(`2018` ~ plant_pathogen, data = guild_carbon10)
summary(surface_plant_pathogen_current)

surface_plant_pathogen_recent = lm(change18 ~ plant_pathogen, data = guild_carbon10)
summary(surface_plant_pathogen_recent)

surface_plant_pathogen_future = lm(change21 ~ plant_pathogen, data = guild_carbon10)
summary(surface_plant_pathogen_future)
```

#### all_ecto
```{r}
surface_all_ecto_current = lm(`2018` ~ all_ecto, data = guild_carbon10)
summary(surface_all_ecto_current)

surface_all_ecto_recent = lm(change18 ~ all_ecto, data = guild_carbon10)
summary(surface_all_ecto_recent)

surface_all_ecto_future = lm(change21 ~ all_ecto, data = guild_carbon10)
summary(surface_all_ecto_future)
```

#### only_ecto
```{r}
surface_ectomycorrhizal_current = lm(`2018` ~ ectomycorrhizal, data = guild_carbon10)
summary(surface_ectomycorrhizal_current)

surface_ectomycorrhizal_recent = lm(change18 ~ ectomycorrhizal, data = guild_carbon10)
summary(surface_ectomycorrhizal_recent)

surface_ectomycorrhizal_future = lm(change21 ~ ectomycorrhizal, data = guild_carbon10)
summary(surface_ectomycorrhizal_future)
```

#### only_arbuscular
```{r}
surface_arbuscular_mycorrhizal_current = lm(`2018` ~ arbuscular_mycorrhizal, data = guild_carbon10)
summary(surface_arbuscular_mycorrhizal_current)

surface_arbuscular_mycorrhizal_recent = lm(change18 ~ arbuscular_mycorrhizal, data = guild_carbon10)
summary(surface_arbuscular_mycorrhizal_recent)

surface_arbuscular_mycorrhizal_future = lm(change21 ~ arbuscular_mycorrhizal, data = guild_carbon10)
summary(surface_arbuscular_mycorrhizal_future)
```


### models Depth


#### saptrotroph_only
```{r}
depth_saprotroph_only_current = lm(`2018` ~ saprotroph_only, data = guild_carbon40)
summary(depth_saprotroph_only_current)

depth_saprotroph_only_recent = lm(change18 ~ saprotroph_only, data = guild_carbon40)
summary(depth_saprotroph_only_recent)

depth_saprotroph_only_future = lm(change21 ~ saprotroph_only, data = guild_carbon40)
summary(depth_saprotroph_only_future)
```

#### all_saprotroph

```{r}
depth_all_saprotroph_current = lm(`2018` ~ all_saprotroph, data = guild_carbon40)
summary(depth_all_saprotroph_current)

depth_all_saprotroph_recent = lm(change18 ~ all_saprotroph, data = guild_carbon40)
summary(depth_all_saprotroph_recent)

depth_all_saprotroph_future = lm(change21 ~ all_saprotroph, data = guild_carbon40)
summary(depth_all_saprotroph_future)
```

#### all_mycorrhizae
```{r}
depth_all_mycorrhizae_current = lm(`2018` ~ all_mycorrhizae, data = guild_carbon40)
summary(depth_all_mycorrhizae_current)

depth_all_mycorrhizae_recent = lm(change18 ~ all_mycorrhizae, data = guild_carbon40)
summary(depth_all_mycorrhizae_recent)

depth_all_mycorrhizae_future = lm(change21 ~ all_mycorrhizae, data = guild_carbon40)
summary(depth_all_mycorrhizae_future)
```


#### mycorrhizae_only
```{r}
depth_mycorrhizal_only_current = lm(`2018` ~ mycorrhizal_only, data = guild_carbon40)
summary(depth_mycorrhizal_only_current)

depth_mycorrhizal_only_recent = lm(change18 ~ mycorrhizal_only, data = guild_carbon40)
summary(depth_mycorrhizal_only_recent)

depth_mycorrhizal_only_future = lm(change21 ~ mycorrhizal_only, data = guild_carbon40)
summary(depth_mycorrhizal_only_future)
```


#### plant_pathogens
```{r}
depth_plant_pathogen_current = lm(`2018` ~ plant_pathogen, data = guild_carbon40)
summary(depth_plant_pathogen_current)

depth_plant_pathogen_recent = lm(change18 ~ plant_pathogen, data = guild_carbon40)
summary(depth_plant_pathogen_recent)

depth_plant_pathogen_future = lm(change21 ~ plant_pathogen, data = guild_carbon40)
summary(depth_plant_pathogen_future)
```

#### all_ecto
```{r}
depth_all_ecto_current = lm(`2018` ~ all_ecto, data = guild_carbon40)
summary(depth_all_ecto_current)

depth_all_ecto_recent = lm(change18 ~ all_ecto, data = guild_carbon40)
summary(depth_all_ecto_recent)

depth_all_ecto_future = lm(change21 ~ all_ecto, data = guild_carbon40)
summary(depth_all_ecto_future)
```

#### only_ecto
```{r}
depth_ectomycorrhizal_current = lm(`2018` ~ ectomycorrhizal, data = guild_carbon40)
summary(depth_ectomycorrhizal_current)

depth_ectomycorrhizal_recent = lm(change18 ~ ectomycorrhizal, data = guild_carbon40)
summary(depth_ectomycorrhizal_recent)

depth_ectomycorrhizal_future = lm(change21 ~ ectomycorrhizal, data = guild_carbon40)
summary(depth_ectomycorrhizal_future)
```

```{r}
depth_arbuscular_mycorrhizal_current = lm(`2018` ~ arbuscular_mycorrhizal, data = guild_carbon40)
summary(depth_arbuscular_mycorrhizal_current)

depth_arbuscular_mycorrhizal_recent = lm(change18 ~ arbuscular_mycorrhizal, data = guild_carbon40)
summary(depth_arbuscular_mycorrhizal_recent)

depth_arbuscular_mycorrhizal_future = lm(change21 ~ arbuscular_mycorrhizal, data = guild_carbon40)
summary(depth_arbuscular_mycorrhizal_future)
```







### Plots

```{r}
(saprotroph_plot = ggplot(guild_carbon, aes(x = saprotroph_only, y = change21)) +
  geom_point() +
  facet_wrap(. ~ depth_text) +
  theme_bw() +
  facet_grid(. ~ depth_text) +
  theme(axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill="white")) +
  geom_smooth(data = guild_carbon10, method = "lm", color = "black", linetype = "dashed") +
  ylab("% Change SOC 2018-21") +
  xlab("Saprotroph Relative Abundance 2018"))


ggsave(here::here("documents/figures/saprotroph_plot.png"), dpi = 300, plot = saprotroph_plot, device = "png", width = 8, height = 6)

```

## Combined plot

```{r}
(plot_fungus_all = ggarrange(fung_richness, fung_richness_recent, saprotroph_plot, nrow = 3, labels = "AUTO", label.x = 0.00, label.y = 1)
)
ggsave(here::here("documents/figures/plot_fungus_all.png"), dpi = 300, plot = plot_fungus_all, device = "png", width = 10, height = 12)

```

# Vegetation

## Data Cleanup
```{r}



com_table_18 = com_table %>% 
  filter(year == "2018") %>% 
  column_to_rownames("point_id") %>% 
  select(-year) %>% 
  decostand(method = "total") %>% 
  select(where(~ any(. != 0)))

com_table_21 = com_table %>% 
  filter(year == "2021") %>% 
  column_to_rownames("point_id") %>% 
  select(-year)%>% 
  decostand(method = "total") %>% 
  select(where(~ any(. != 0)))


com_table_fun_standard18 = com_table_fun %>% 
  filter(year == "2018") %>% 
  column_to_rownames("point_id") %>% 
  select(-year) %>% 
  decostand(method = "total") %>% 
  select(where(~ any(. != 0)))


com_table_fun_standard21 = com_table_fun %>% 
  filter(year == "2021") %>% 
  column_to_rownames("point_id") %>% 
  select(-year) %>% 
  decostand(method = "total") %>% 
  select(where(~ any(. != 0)))


soil_veg = change10 %>% 
  left_join(change40, by = "point_name", suffix = c("_10", "_40")) %>% 
  column_to_rownames("point_name") %>% 
  filter(rownames(.) %in% rownames(com_table_18)) %>% 
  select(-contains("depth"))

soil_veg_complete = soil_veg %>% 
  select(- contains("21"), -contains("15"), -contains("14"))

soil_veg_future = soil_veg %>% 
  select(contains("change21")) %>% 
  filter(!is.na(change21_10))

com_table_future = com_table_18 %>% 
  filter(rownames(.) %in% rownames(soil_veg_future))

com_table_fun_future = com_table_fun_standard18 %>% 
  filter(rownames(.) %in% rownames(soil_veg_future))

richness_18 = specnumber(com_table_18)
richness21 = specnumber(com_table_21)


mean(richness_18); sd(richness_18)
mean(richness21); sd(richness21)

max(com_table_18$PHAQ)
max(com_table_18$DACA3)

hist(com_table_18$PHAQ, breaks = 30)
hist(com_table_18$DACA3,breaks = 30)
hist(com_table_18$NAPU4,breaks = 30)

```

## Soil summaries
```{r}

soil_sum = soil_veg %>% 
  mutate(first10 = coalesce(`2015_10`, `2014_10`),
         first40 = coalesce(`2015_40`, `2014_40`)) %>% 
  summarise(mean1510 = mean(first10, na.rm = T), sd1510 = sd(first10, na.rm = T),
            mean1540 = mean(first40, na.rm = T), sd1540 = sd(first40, na.rm = T),
            mean1810 = mean(`2018_10`, na.rm = T), sd1810 = sd(`2018_10`, na.rm = T),
            mean1840 = mean(`2018_40`, na.rm = T), sd1840 = sd(`2018_40`, na.rm = T),
            mean2110 = mean(`2021_10`, na.rm = T), sd210 = sd(`2021_10`, na.rm = T),
            mean2140 = mean(`2021_40`, na.rm = T), sd2140 = sd(`2021_40`, na.rm = T),
            meanchange1810 = mean(change18_10, na.rm = T), sdchange1810 = sd(change18_10, na.rm = T),
            meanchange1840 = mean(change18_40, na.rm = T), sdchange1840 = sd(change18_40, na.rm = T),
            meanchange2110 = mean(change21_10, na.rm = T), sdchange2110 = sd(change21_10, na.rm = T),
            meanchange2140 = mean(change21_40, na.rm = T), sdchange2140 = sd(change21_40, na.rm = T))

```



## Herbaceous NMDS

```{r}

vegNMDS = metaMDS(com_table_18, distance = "bray", k = 3, maxit = 999, trymax = 500, wascores = TRUE, autotransform = FALSE)

vegNMDS


```


```{r}


veg_scores = as.data.frame(scores(vegNMDS))

soil_veg_scores = envfit(veg_scores, soil_veg_complete, nperm = 999, na.rm = T, choices = c(1:3))
soil_veg_scores_plot = as.data.frame(scores(soil_veg_scores, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change18_10" ~ "0-10cm % Carbon Change",
                              rowname == "2018_10" ~ "0-10cm % Organic C",
                              rowname == "change18_40" ~ "10-40cm % Carbon Change",
                              rowname == "2018_40" ~ "10-40cm % Organic C"
                              ),
         label = case_when(rowname == "change18_10" ~ "A",
                              rowname == "2018_10" ~ "B",
                              rowname == "change18_40" ~ "C",
                              rowname == "2018_40" ~ "D"))


fun_grp_scores = envfit(veg_scores, com_table_fun_standard18, nperm = 999, choices = c(1:3))
fun_grp_scores_plot = as.data.frame(scores(fun_grp_scores, display = "vectors")) %>% 
  rownames_to_column() %>% 
  left_join(as.data.frame(fun_grp_scores$vectors$pvals) %>% rownames_to_column(), by = "rowname") %>% 
  filter(`fun_grp_scores$vectors$pvals` < 0.05) %>% 
  mutate(functional_group = case_when(rowname == "SedgesRushes" ~ "Sedges/Rushes",
                                      rowname != "SedgesRushes" ~ rowname))

  # left_join(as.data.frame(fam_16_env10$vectors$pvals) %>% rownames_to_column(), by = "rowname")

veg_scores = as.data.frame(scores(vegNMDS)) %>% 
  rownames_to_column() %>% 
  left_join(soil_veg %>% rownames_to_column(), by = "rowname") 

```

### plot
```{r}
(veg_1_2 = ggplot(veg_scores, aes(NMDS1, NMDS2)) +
  geom_point(aes(color = `2018_10`), size = 3) +
  geom_segment(data = soil_veg_scores_plot, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "black", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text_repel(data = soil_veg_scores_plot, aes(x = NMDS1, y = NMDS2, label = label),
            size = 6, box.padding = 0.25) +
  geom_text_repel(data = fun_grp_scores_plot, mapping = aes(x = NMDS1, y = NMDS2, label = functional_group), color = "blue", size = 6) +
  scale_color_viridis_c(name = "% Organic C 0-10 cm", limits = c(2, 5), na.value = "#FDE725FF", breaks = c(2, 3, 4, 5), labels=c(2, 3, 4, ">5")) +
  theme(axis.title = element_text(size = 14))+
  theme_bw())

# ggsave(here::here("documents/figures/0_10_veg_NMDS_12.png"), dpi = 300, plot = veg_1_2, device = "png", width = 8, height = 6)


```

```{r}
(veg_1_3 = ggplot(veg_scores, aes(NMDS1, NMDS3)) +
  geom_point(aes(color = `2018_10`), size = 3)+
  geom_segment(data = soil_veg_scores_plot, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS3), 
               color = "black", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text_repel(data = soil_veg_scores_plot, aes(x = NMDS1, y = NMDS3, label = label),
            size = 6, box.padding = 0.25) +
  geom_text_repel(data = fun_grp_scores_plot, mapping = aes(x = NMDS1, y = NMDS3, label = functional_group), color = "blue", size = 6) +
  scale_color_viridis_c(name = "% Organic C 0-10 cm", limits = c(2, 5), na.value = "#FDE725FF", breaks = c(2, 3, 4, 5), labels=c(2, 3, 4, ">5")) +
  theme_bw())  +
  theme(axis.title = element_text(size = 14))

ggsave(here::here("documents/figures/0_10_veg_NMDS_13.png"), dpi = 300, plot = veg_1_3, device = "png", width = 8, height = 6)
```
```{r}
library(ggpubr)

(veg_NMDS_all = ggarrange(veg_1_2, veg_1_3, common.legend = TRUE, legend = "right", ncol = 1)  +
  theme(axis.title = element_text(size = 12)))

ggsave(here::here("documents/figures/veg_NMDS_all.png"), dpi = 300, plot = veg_NMDS_all, device = "png", width = 8, height = 12)

```


### stats

```{r}
soil_veg_scores
fun_grp_scores
```

## NMDS Future

```{r}
veg_future_NMDS = metaMDS(com_table_future, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE, autotransform = FALSE)

veg_future_NMDS
```


```{r}
veg_scores_future = as.data.frame(scores(veg_future_NMDS))


soil_veg_scores_future = envfit(veg_scores_future, soil_veg_future, nperm = 999, na.rm = T, choices = c(1:3))
soil_veg_scores_future_plot = as.data.frame(scores(soil_veg_scores_future, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change18_10" ~ "0-10cm % Carbon Change",
                              rowname == "2018_10" ~ "0-10cm % Organic C",
                              rowname == "change18_40" ~ "10-40cm % Carbon Change",
                              rowname == "2018_40" ~ "10-40cm % Organic C"
                              ),
         label = case_when(rowname == "change21_10" ~ "0-10cm",
                              rowname == "change21_40" ~ "10-40cm"))


fun_grp_scores_future = envfit(veg_scores_future, com_table_fun_future, nperm = 999, choices = c(1:3))
fun_grp_scores_future_plot = as.data.frame(scores(fun_grp_scores_future, display = "vectors")) %>% 
  rownames_to_column() %>% 
  left_join(as.data.frame(fun_grp_scores$vectors$pvals) %>% rownames_to_column(), by = "rowname") %>% 
  filter(`fun_grp_scores$vectors$pvals` < 0.05) %>% 
  mutate(functional_group = case_when(rowname == "SedgesRushes" ~ "Sedges/Rushes",
                                      rowname != "SedgesRushes" ~ rowname))

  # left_join(as.data.frame(fam_16_env10$vectors$pvals) %>% rownames_to_column(), by = "rowname")

veg_scores_future = as.data.frame(scores(veg_future_NMDS)) %>% 
  rownames_to_column() %>% 
  left_join(soil_veg_future %>% rownames_to_column(), by = c("rowname")) 

```
veg_scores_future = as.data.frame(scores(veg_future_NMDS))

### plot

```{r}
(veg_future = ggplot(veg_scores_future, aes(NMDS1, NMDS2)) +
  geom_point(aes(color = change21_10), size = 3) +
  geom_segment(data = soil_veg_scores_future_plot, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "black", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text_repel(data = soil_veg_scores_future_plot, aes(x = NMDS1, y = NMDS2, label = label),
            size = 6, box.padding = 0.1) +
  geom_text_repel(data = fun_grp_scores_future_plot, mapping = aes(x = NMDS1, y = NMDS2, label = functional_group), color = "blue", size = 6) +
  scale_color_viridis_c(name = "Change 2018-21 \n%SOC 0-10 cm ") + 
  theme_bw()) +
  theme(axis.title = element_text(size = 14))

ggsave(here::here("documents/figures/veg_future_NMDS.png"), dpi = 300, plot = veg_future, device = "png", width = 8, height = 6)


soil_veg_scores_future
```
### stats

```{r}
soil_veg_scores_future

```


## Functional Groups
```{r}

funchange = com_table_fun_standard18 %>% 
  rownames_to_column() %>% 
  left_join(com_table_fun_standard21 %>% rownames_to_column(), by = "rowname") %>% 
  clean_names() %>% 
  mutate(pg_change = perennial_grass_y - perennial_grass_x,
         ag_change = annual_grass_y - annual_grass_x,
         af_change = annual_forb_y - annual_forb_x,
         pf_change = perennial_forb_y - perennial_forb_x,
         pa_change = (perennial_grass_y/annual_grass_y) - (perennial_grass_x/annual_grass_x)) %>% 
  select(rowname, pg_change, ag_change, af_change, pf_change, pa_change)


fun_table_soil = com_table_fun_standard18 %>% 
  rownames_to_column() %>% 
  left_join(soil_veg %>% rownames_to_column(), by = "rowname") %>% 
  left_join(bare_ground %>% filter(year == 2018), by = c("rowname" = "point_id")) %>% 
  clean_names() %>% 
  mutate(p_a_grass = perennial_grass/annual_grass) %>% 
  left_join(funchange, by = "rowname")
```



### Models

```{r}
bg_pg = lm(perennial_grass ~ relative_bareground, data = fun_table_soil)
summary(bg_pg)

ggplot(fun_table_soil, aes(x = relative_bareground, y = perennial_grass, color = x2018_10)) +
  geom_point()
```


#### bare ground

```{r}
bg_mod_surface = lm(x2018_10 ~ relative_bareground, data = fun_table_soil)
summary(bg_mod_surface)

bg_mod_depth = lm(x2018_40 ~ relative_bareground, data = fun_table_soil)
summary(bg_mod_depth)

bg_mod_surface_past = lm(change18_10 ~ relative_bareground, data = fun_table_soil)
summary(bg_mod_surface_past)

bg_mod_depth_past = lm(change18_40 ~ relative_bareground, data = fun_table_soil)
summary(bg_mod_depth_past)


bg_mod_surface_future = lm(change21_10 ~ relative_bareground, data = fun_table_soil)
summary(bg_mod_surface_future)

bg_mod_depth_future = lm(change21_40 ~ relative_bareground, data = fun_table_soil)
summary(bg_mod_depth_future)
```


#### Perennial Grass

```{r}

# current
pg_mod_surface = lm(x2018_10 ~ perennial_grass, data = fun_table_soil)
summary(pg_mod_surface)

pg_mod_depth = lm(x2018_40 ~ perennial_grass, data = fun_table_soil)
summary(pg_mod_depth)

#past
pg_mod_surface_past = lm(change18_10 ~ perennial_grass, data = fun_table_soil)
summary(pg_mod_surface_past)

pg_mod_depth_past = lm(change18_40 ~ perennial_grass, data = fun_table_soil)
summary(pg_mod_depth_past)

# future

pg_mod_surface_future = lm(change21_10 ~ perennial_grass, data = fun_table_soil) ## significant
summary(pg_mod_surface_future)

pg_mod_depth_future = lm(change21_40 ~ perennial_grass, data = fun_table_soil) ## significant
summary(pg_mod_depth_future)

pg_mod_surface_change = lm(change21_10 ~ pg_change, data = fun_table_soil)
summary(pg_mod_surface_change)

pg_mod_depth_change = lm(change21_40 ~ pg_change, data = fun_table_soil)
summary(pg_mod_depth_change)


```
#### annual grass
```{r}

# current
ag_mod_surface = lm(x2018_10 ~ annual_grass, data = fun_table_soil)
summary(ag_mod_surface)

ag_mod_depth = lm(x2018_40 ~ annual_grass, data = fun_table_soil)
summary(ag_mod_depth)



#past
ag_mod_surface_past = lm(change18_10 ~ annual_grass, data = fun_table_soil)
summary(ag_mod_surface_past)

ag_mod_depth_past = lm(change18_40 ~ annual_grass, data = fun_table_soil)
summary(ag_mod_depth_past)

# future

ag_mod_surface_future = lm(change21_10 ~ annual_grass, data = fun_table_soil) ## significant
summary(ag_mod_surface_future)

ag_mod_depth_future = lm(change21_40 ~ annual_grass, data = fun_table_soil) ## significant
summary(ag_mod_depth_future)

ag_mod_surface_change = lm(change21_10 ~ ag_change, data = fun_table_soil)
summary(ag_mod_surface_change)

ag_mod_depth_change = lm(change21_40 ~ ag_change, data = fun_table_soil)
summary(ag_mod_depth_change)


```
#### P:a


There's and outlier here, makes it kind of hard to use the ratio
```{r}

# current
p_a_mod_surface = lm(x2018_10 ~ p_a_grass, data = fun_table_soil)
summary(p_a_mod_surface)

p_a_mod_depth = lm(x2018_40 ~ p_a_grass, data = fun_table_soil)
summary(p_a_mod_depth)



#past
p_a_mod_surface_past = lm(change18_10 ~ p_a_grass, data = fun_table_soil)
summary(p_a_mod_surface_past)

p_a_mod_depth_past = lm(change18_40 ~ p_a_grass, data = fun_table_soil)
summary(p_a_mod_depth_past)

# future

p_a_mod_surface_future = lm(change21_10 ~ p_a_grass, data = fun_table_soil) ## significant
summary(p_a_mod_surface_future)

p_a_mod_depth_future = lm(change21_40 ~ p_a_grass, data = fun_table_soil) ## significant
summary(p_a_mod_depth_future)

pa_mod_surface_change = lm(change21_10 ~ pa_change, data = fun_table_soil) # reports significance but its all about the outlier
summary(pa_mod_surface_change)

pa_mod_depth_change = lm(change21_40 ~ pa_change, data = fun_table_soil)
summary(pa_mod_depth_change)



ggplot(fun_table_soil, aes(x = pa_change, y = change21_10)) +
  geom_point()

```
### Plot

```{r}
(pg_plot = ggplot(fun_table_soil, aes(x = perennial_grass, y = change21_10)) +
  geom_point() +
  # xlim(0, 0.5) +
  geom_smooth(method = "lm", color = "black") +
  theme_bw() +
  # theme(axis.title = element_text()) +
  xlab("Perennial Grass Cover 2018") +
  ylab("Change % SOC 0-10cm 2018-21"))

(pg_plot40 = ggplot(fun_table_soil, aes(x = perennial_grass, y = change21_40)) +
  geom_point() +
  # xlim(0, 0.5) +
  geom_smooth(method = "lm", color = "black") +
  theme_bw() +
  # theme(axis.title = element_text()) +
  xlab("Perennial Grass Cover 2018") +
  ylab("Change % SOC 10-40cm 2018-21"))

(ag_plot = ggplot(fun_table_soil, aes(x = annual_grass, y = change21_10)) +
  geom_point() +
  # xlim(0, 0.5) +
  geom_smooth(method = "lm", color = "black") +
  theme_bw() +
  # theme(axis.title = element_text()) +
  xlab("Annaul Grass Cover 2018") +
  ylab("Change % SOC 0-10cm 2018-21"))

(ag_plot40 = ggplot(fun_table_soil, aes(x = annual_grass, y = change21_40)) +
  geom_point() +
  # xlim(0, 0.5) +
  geom_smooth(method = "lm", color = "black") +
  theme_bw() +
  # theme(axis.title = element_text()) +
  xlab("Annual Grass Cover 2018") +
  ylab("Change % SOC 10-40cm 2018-21"))



```



## Diversity analyses
```{r}
divs = diversity(com_table_18, index= "shannon") %>% 
  as.data.frame() %>% 
  clean_names() %>% 
  rename(diversity18 = x) %>% 
  rownames_to_column()

divs_21 = diversity(com_table21_change) %>% 
  as.data.frame() %>% 
  clean_names() %>% 
  rename(diversity21 = x) %>% 
  rownames_to_column()

diversity_soil = divs %>% 
  left_join(divs_21, by = "rowname") %>% 
  left_join(soil_veg %>% rownames_to_column(), by = "rowname") %>% 
  mutate(diversity_change = diversity21 - diversity18)

```


### Models

#### current models
```{r}


div_surf_mod = lm(`2018_10` ~ diversity18, data = diversity_soil)
summary(div_surf_mod)

div_depth_mod = lm(`2018_40` ~ diversity18, data = diversity_soil)
summary(div_depth_mod)

```
#### Past Change Models
```{r}

div_surf_change_mod = lm(change18_10 ~ diversity18, data = diversity_soil) 
summary(div_surf_change_mod)

div_depth_change_mod = lm(change18_40 ~ diversity18, data = diversity_soil)
summary(div_depth_change_mod)

```


```{r}

div_surf_future_mod = lm(change21_10 ~ diversity18, data = diversity_soil)
summary(div_surf_future_mod)

div_depth_future_mod = lm(change21_40 ~ diversity18, data = diversity_soil)
summary(div_depth_future_mod)

```

```{r}

div_change_surf = lm(change21_10 ~ diversity_change, data = diversity_soil)
summary(div_change_surf)

div_change_surf = lm(change21_40 ~ diversity_change, data = diversity_soil)
summary(div_change_surf)

```


## Canopy

Join to soil data
```{r}

canopy_change = canopy_cover %>% 
  ungroup() %>% 
  group_by(point_id) %>% 
  filter(n() > 1) %>% 
  summarise(canopy_change = diff(percent_cover))

canopy_soil = canopy_cover %>% 
  filter(year == 2018) %>% 
  filter(point_id %in% rownames(soil_veg)) %>% 
  left_join(soil_veg %>% rownames_to_column("point_id"), by = "point_id") %>% 
  left_join(canopy_change, by = "point_id")



```

### Models

```{r}
canopy_surface_current = lm(`2018_10` ~ percent_cover, data = canopy_soil)
summary(canopy_surface_current)

canopy_depth_current = lm(`2018_40` ~ percent_cover, data = canopy_soil)
summary(canopy_depth_current)

canopy_surface_recent = lm(change18_10 ~ percent_cover, data = canopy_soil)
summary(canopy_surface_recent)

canopy_depth_recent = lm(change18_40 ~ percent_cover, data = canopy_soil)
summary(canopy_depth_recent)

canopy_surface_future = lm(change21_10 ~ percent_cover, data = canopy_soil)
summary(canopy_surface_future)

canopy_depth_future = lm(change21_40 ~ percent_cover, data = canopy_soil)
summary(canopy_depth_future)

canopy_surface_future_change = lm(change21_10 ~ canopy_change, data = canopy_soil)
summary(canopy_surface_future_change) ## significant

canopy_depth_future_change = lm(change21_40 ~ canopy_change, data = canopy_soil)
summary(canopy_depth_future_change)

plot(canopy_surface_future_change)

```

### Canopy Plot

```{r}
(canopy_plot = ggplot(canopy_soil, aes(x = canopy_change, y = change21_10)) +
  geom_point() +
  # xlim(0, 0.5) +
  geom_smooth(method = "lm", color = "black") +
  theme_bw() +
  # theme(axis.title = element_text()) +
  xlab("Change in Woody Cover 2018-2021") +
  ylab("Change % SOC 0-10cm 2018-21"))

(canopy_plot40 = ggplot(canopy_soil, aes(x = canopy_change, y = change21_40)) +
  geom_point() +
  # xlim(0, 0.5) +
  # geom_smooth(method = "lm", color = "black") +
  theme_bw() +
  # theme(axis.title = element_text()) +
  xlab("Change in Woody Cover 2018-2021") +
  ylab("Change % SOC 10-40cm 2018-21"))


ggsave(here::here("documents/figures/canopy_plot.png"), dpi = 300, plot = canopy_plot, device = "png", width = 8, height = 6)

```

## Plot all veg groups

```{r}
(veg_plot = ggarrange(pg_plot, pg_plot40, ag_plot, ag_plot40, canopy_plot, canopy_plot40, ncol = 2, nrow = 3, labels = "AUTO"))

ggsave(here::here("documents/figures/veg_functions_all.png"), dpi = 300, plot = veg_plot, device = "png", width = 10, height = 12)

```


# Combined analyses

##current soc 

C:O, fungal richness
```{r}

bact_fung_current = fam_carbon_function %>% 
  rownames_to_column() %>% 
  left_join(fungal_richness %>% rownames_to_column(), by = "rowname") %>% 
  select(rowname, `2018`, change18, change21, c_o_ratio, richness, depth_text) %>% 
  column_to_rownames("rowname")

bact_fung_current10 = bact_fung_current %>% 
  filter(depth_text == "0-10 cm")

bact_fung_current40 = bact_fung_current %>% 
  filter(depth_text == "10-40 cm")

GGally::ggpairs(bact_fung_current10)
GGally::ggpairs(bact_fung_current40)


```



### surface
```{r}
c_o_fung_richness10_full = lm(`2018` ~ richness + c_o_ratio + c_o_ratio:richness, data = bact_fung_current10)
summary(c_o_fung_richness10_full)


stepAIC(c_o_fung_richness10_full)

c_o_fung_richness10_noint = lm(`2018` ~ richness + c_o_ratio, data = bact_fung_current10)
summary(c_o_fung_richness10_noint)


AIC(c_o_fung_richness10_full, c_o_fung_richness10_noint)

  plot(c_o_fung_richness10_noint)



```

### depth

Only c_o was good for depth

```{r}
c_o_fung_richness40_full = lm(`2018` ~ richness + c_o_ratio + c_o_ratio:richness, data = bact_fung_current40)
summary(c_o_fung_richness40_full)

c_o_fung_richness40_noint = lm(`2018` ~ richness + c_o_ratio, data = bact_fung_current40)
summary(c_o_fung_richness40_fullx)

AIC(c_o_fung_richness40_full, c_o_fung_richness40_noint)
```



## past soc

Plant diversity (surface), fungal richness (depth)
Ok so no multiple predictors
```{r}

```

## future soc

perennial grass/annual grass, woody change, bacterial c:o, bacterial richness, saprotroph

```{r}

canopy_change10 = canopy_change %>% 
  mutate(rowname = paste(point_id, "-10", sep = ""))

canopy_change40 = canopy_change %>% 
  mutate(rowname = paste(point_id, "-40", sep = ""))

future_table_soil10 = fun_table_soil %>% 
  mutate(rowname = paste(rowname, "-10", sep = "")) %>% 
  select(rowname, perennial_grass, annual_grass, change21_10) %>% 
  left_join(canopy_change10, by = "rowname") %>% 
  left_join(fam_carbon_function10 %>% rownames_to_column %>% select(rowname, c_o_ratio), by = "rowname") %>% 
  left_join(microbe_richness %>% rownames_to_column(), by = "rowname") %>% 
  left_join(guild_carbon10 %>% select(saprotroph_only) %>% rownames_to_column(), by = "rowname") %>% 
  column_to_rownames("rowname") %>% 
  filter(!is.na(change21_10))

future_table_soil40 = fun_table_soil %>% 
  mutate(rowname = paste(rowname, "-40", sep = "")) %>% 
  select(rowname, perennial_grass, annual_grass, change21_40) %>% 
  left_join(canopy_change40, by = "rowname") %>% 
  left_join(fam_carbon_function40 %>% rownames_to_column %>% select(rowname, c_o_ratio), by = "rowname") %>% 
  left_join(microbe_richness %>% rownames_to_column(), by = "rowname") %>% 
  left_join(guild_carbon40 %>% select(saprotroph_only) %>% rownames_to_column(), by = "rowname") %>% 
  column_to_rownames("rowname") %>% 
  filter(!is.na(change21_40))


GGally::ggpairs(future_table_soil10)
GGally::ggpairs(future_table_soil40)

```

### surface

perennial/annual grass are correlated, c_o and richness are correlated
```{r}
full_future_mod10 = lm(change21_10 ~ perennial_grass + canopy_change + c_o_ratio + saprotroph_only, data = future_table_soil10)
summary(full_future_mod10)



stepAIC(full_future_mod10)

#easy to interpret, avoids interactions
future_mod10_no_woody_noint = lm(change21_10 ~ c_o_ratio + perennial_grass + saprotroph_only, data = future_table_soil10)
summary(future_mod10_no_woody_noint)


##best
future_mod10_no_woody = lm(change21_10 ~ c_o_ratio + perennial_grass + saprotroph_only + c_o_ratio:saprotroph_only, data = future_table_soil10)
summary(future_mod10_no_woody)

#lower AIC but harder to interpret
future_mod10_no_fungus = lm(change21_10 ~ c_o_ratio + perennial_grass + c_o_ratio:saprotroph_only, data = future_table_soil10)
summary(future_mod10_no_fungus)

stepAIC(future_mod10_no_woody)

AIC(future_mod10_no_woody, future_mod10_no_woody_noint, future_mod10_no_fungus)






```

```{r}
full_richness_future_mod40 = lm(change21_40 ~ richness*perennial_grass, data = future_table_soil40)
summary(full_future_mod40)

full_co_future_mod40 = lm(change21_40 ~ c_o_ratio*perennial_grass, data = future_table_soil40)
summary(full_co_future_mod40)

AIC(full_richness_future_mod40, full_co_future_mod40)

stepAIC(full_richness_future_mod40)

best_future40 = lm(change21_40 ~ richness + c_o_ratio + perennial_grass + richness:c_o_ratio + richness:perennial_grass, data = future_table_soil40)
summary(best_future40)

future40_noint = lm(change21_40 ~ richness + c_o_ratio + perennial_grass + richness:perennial_grass  + richness:c_o_ratio, data = future_table_soil40)
summary(future40_noint)

final = lm(change21_40 ~ richness + perennial_grass, data = future_table_soil40)
summary(final)

AIC(final, full_richness_future_mod40)

plot(best_future40)

stepAIC(full_co_future_mod40)


final_co = lm(formula = change21_40 ~ c_o_ratio + perennial_grass, data = future_table_soil40)
summary(final_co)


plot(final_co)
AIC(final, final_co)
```


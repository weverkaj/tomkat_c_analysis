---
title: "Gradient analysis finalized"
output: html_document
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(vegan)
library(here)
library(janitor)
library(ggpubr)
library(calecopal)
library(lubridate)

```

#Soil Data Prep

## Read-in
```{r}
data_nut = tibble(files = list.files(here("data/soil"))) %>%
  mutate(data = map(files, ~ read_csv(here(paste("data/soil/"), .x), 
                                      col_types = cols(`Olsen P` = col_character(),
                                                       `Sodium` = col_double(),
                                                       `Total Nitrogen` = col_double(),
                                                       `pH` = col_double(),
                                                       `Sand` = col_double(),
                                                       `Silt` = col_double(),
                                                       `Clay` = col_double()
                                                       )
                                      )
                    )
         )  

data_rmn_raw = read_csv(here("data/soil/toka_soil_surveys.csv"))

```

## aggregate data
```{r}
# group data
visits_c = data_rmn_raw %>% 
  janitor::clean_names() %>% 
  group_by(point_name, date) %>% 
  select(transect_name, point_name, date, sample_number, carbon_0_10_cm, carbon_10_40_cm, clay_10_40_cm, silt_10_40_cm, sand_10_40_cm, grazed_this_year, bare_ground, litter_depth, catenal_position, starts_with("bulk"), max_depth) %>% 
  nest() %>% 
  ungroup() %>% 
  group_by(point_name) %>% 
  mutate(visit = row_number()) %>%  
  mutate(carbon_0_10 = map_dbl(data, ~ median(.x$carbon_0_10_cm)),
         carbon_10_40 = map_dbl(data, ~ median(.x$carbon_10_40_cm)),
         clay = map_dbl(data, ~ median(.x$clay_10_40_cm)),
         c_change_10 = c(NA, diff(carbon_0_10)),
         c_change_40 = c(NA, diff(carbon_10_40))) %>% 
  ungroup()

#surface points
points_c_surface = visits_c %>% 
  group_by(point_name) %>% 
  mutate(year = lubridate::year(date)) %>% 
  pivot_wider(id_cols = point_name, names_from = year, values_from = carbon_0_10) %>% 
  mutate(change18 = case_when(!is.na(`2015`) ~ `2018`- `2015`,
                              is.na(`2015`) ~ `2018`- `2014`),
         change21 = `2021`- `2018`,
         depth = 10,
         id = paste(point_name, depth, sep = "-"))

#deep points
points_c_depth = visits_c %>% 
  group_by(point_name) %>% 
  mutate(year = lubridate::year(date)) %>% 
  pivot_wider(id_cols = point_name, names_from = year, values_from = carbon_10_40) %>% 
  mutate(change18 = case_when(!is.na(`2015`) ~ `2018`- `2015`,
                              is.na(`2015`) ~ `2018`- `2014`),
         change21 = `2021`- `2018`,
         depth = 40,
         id = paste(point_name, depth, sep = "-"))

#all points
toka_c_points = bind_rows(points_c_surface, points_c_depth) %>% 
  column_to_rownames("id") %>% 
  mutate(depth = as.factor(depth)) %>% 
  mutate(depth_text = case_when(depth == 10 ~ "0-10 cm",
                           depth == 40 ~ "10-40 cm"))

change_future = toka_c_points %>% 
  select(`2015`, `2018`, change18, change21, depth) %>% 
  rownames_to_column() %>% 
  filter(!is.na(change21)) %>% 
  column_to_rownames("rowname")

```



```{r}
change10 = toka_c_points %>% 
  filter(depth == "10")

change40 = toka_c_points %>% 
  filter(depth == "40")

change10_future = change10 %>% 
  filter(!is.na(change21))

change40_future = change40 %>% 
  filter(!is.na(change21))



```

#16S data prep

## Read-in

```{r}
otu_table = read_table2(here("data/16S/table-w-taxonomy.txt"), skip = 1) %>% 
  select(-`TOKA-099-10`)
braycurtis = read_tsv(here("data/16S/braycurtis.tsv"))
jaccard = read_tsv(here("data/16S/jaccard.tsv"))
shannon = read_tsv(here("data/16S/shannon.tsv"))
```

```{r}

#full otu table

otu_straight = otu_table %>% 
  column_to_rownames("#OTU_ID") %>% 
  select(starts_with("TOKA")) %>% 
  t() %>% 
  as.data.frame() %>% 
  select_if(colSums(.) != 0)

#standardized otu table

otu_standard = decostand(otu_straight, method = "total")
```

```{r}
#key to phyla

phylum_key = otu_table %>% 
  select(`#OTU_ID`, p)

#table of phylum occurence
family_table = otu_straight %>% 
  rownames_to_column("point_id") %>% 
  pivot_longer(-point_id) %>% 
  left_join(phylum_key, by = c("name" = "#OTU_ID")) %>% 
  group_by(point_id, p) %>% 
  mutate(p = str_remove(p, ";")) %>% 
  summarise(family_count = sum(value)) %>% 
  pivot_wider(id_cols = point_id, names_from = p, values_from = family_count)

#standardized family table

family_standard = family_table %>% 
  column_to_rownames("point_id") %>% 
  decostand(method = "total")




```
#Fungal Data Prep

##Read-in
```{r}
asv_tab_forward = read_csv(here("data/asv_tab_forward_long.csv")) #asv table
asv_tab_unite = read_csv(here("data/asv_unite_forward..csv")) #taxon assignments in same order as OTUs
asv_guilds = read_csv(here("data/asv_unite_forward_ff.guilds.csv")) %>% clean_names() #functional assignments
```

```{r}

asv_table = asv_tab_forward %>% 
  select(contains("TOKA")) %>% 
  clean_names(case = "all_caps")

colnames(asv_table) = str_replace_all(colnames(asv_table), "_", "-")

```

```{r}
asv_table_standard = asv_table %>% 
  t() %>% 
  decostand(method = "total") %>% 
  t() %>% 
  as.data.frame() %>% 
  select(-`TOKA-099-10`)

asv_table_guilds = asv_table_standard %>% 
  rownames_to_column() %>% 
  left_join(asv_guilds %>% rownames_to_column(), by = "rowname")
```

## functional summary
```{r}
fungal_func_sum = asv_table_guilds %>% 
  select(-trait, -sequence, -taxonomy, -taxon, - taxon_level, -notes, -citation_source, - rowname, - guild, -growth_morphology) %>% 
  filter(confidence_ranking %in% c("Probable", "Highly Probable")) %>% 
  select(-confidence_ranking) %>% 
  pivot_longer(-trophic_mode) %>% 
  group_by(name, trophic_mode) %>% 
  summarize(value = sum(value)) %>% 
  pivot_wider(names_from = trophic_mode, values_from = value) %>% 
  column_to_rownames("name")



fungal_guild_sum = asv_table_guilds %>% 
  select(-trait, -sequence, -taxonomy, -taxon, - taxon_level, -notes, -citation_source, - rowname, -trophic_mode, -growth_morphology) %>% 
  filter(confidence_ranking %in% c("Probable", "Highly Probable")) %>% 
  select(-confidence_ranking) %>% 
  pivot_longer(-guild) %>% 
  group_by(name, guild) %>% 
  summarize(value = sum(value)) %>% 
  pivot_wider(names_from = guild, values_from = value) %>% 
  column_to_rownames("name")

guild_sum = colMeans(fungal_guild_sum) %>% 
  as.data.frame() %>% 
  clean_names() %>% 
  arrange(desc(x))

```

## Divide ASV table into depths
```{r}
asv_all = asv_table_standard %>% 
  t() %>% 
  as.data.frame() %>% 
  select(where(~ any(. != 0)))

asv_10 = asv_table_standard %>% 
  select(ends_with("-10")) %>% 
  t() %>% 
  as.data.frame() %>% 
  select(where(~ any(. != 0)))

asv_40 = asv_table_standard %>% 
  select(ends_with("-40")) %>% 
  t() %>% 
  as.data.frame() %>% 
  select(where(~ any(. != 0)))

```

# Veg data Prep

Read in data    
```{r}
lpi_raw = toka_lpi = read_csv(here("data/veg/toka_lpi.csv"))

lpi_count = lpi_raw %>% 
  janitor::clean_names() %>% 
  filter(!is.na(soil_surface)) %>% 
  group_by(point_id, date) %>% 
  count() %>% 
  mutate(year = year(date))

toka_lpi = lpi_raw %>% 
  janitor::clean_names() %>% 
  filter(!is.na(soil_surface)) %>% 
  mutate(date = lubridate::ymd(date),
         year = lubridate::year(date)) %>% 
  select(point_id, year, top_layer, starts_with("lower")) %>% 
  janitor::remove_empty() %>% 
  pivot_longer(c(top_layer, starts_with("lower")))

toka_canopy = lpi_raw %>% 
  janitor::clean_names() %>% 
  filter(!is.na(soil_surface)) %>% 
  mutate(date = lubridate::ymd(date),
         year = lubridate::year(date)) %>% 
  filter(year != "2016") %>% 
  select(point_id, point_index, direction, year, starts_with("canopy")) %>% 
  janitor::remove_empty() %>% 
  pivot_longer(c(starts_with("canopy")))

```

## Summarize lpi

```{r}

canopy_cover = toka_canopy %>% 
  filter(name == "canopy1",
         ) %>% #!is.na(value)
  group_by(point_id, year)%>% 
  summarise(n = sum(!is.na(value))) %>% 
  left_join(lpi_count, by = c("year", "point_id")) %>% 
  mutate(percent_cover = n.x/n.y) %>% 
  select(point_id, year, percent_cover)

canopy_sum = toka_canopy %>% 
  group_by(point_id, year) %>% 
  count(value) %>% 
  left_join(lpi_count, by = c("year", "point_id")) %>% 
  mutate(percent_cover = n.x/n.y) %>% 
  pivot_wider(id_cols = c(point_id, year), names_from = value, values_from = percent_cover) %>% 
  mutate_all(~ replace_na(.x, 0)) %>% 
  select(-`NA`)
  
  
lpi_sum = toka_lpi %>%   
  group_by(point_id, year) %>% 
  count(value)

com_table = lpi_sum %>% 
  pivot_wider(id_cols = c(point_id, year), names_from = value, values_from = n) %>% 
  mutate_all(~ replace_na(.x, 0)) %>% 
  select(-`NA`, -L, - WL, - NOPLANT)

load(here("data/veg/CAPlantsv2.RData"))

fungrps = CAPlantsv2 %>% 
  janitor::clean_names() %>% 
  select(symbol, fun_grp)

lpi_fun_sum = lpi_sum %>% 
  left_join(fungrps, by = c("value" = "symbol"))


lpi_fun_sum$fun_grp[lpi_fun_sum$value == "2GA"] = "Annual Grass"
lpi_fun_sum$fun_grp[lpi_fun_sum$value == "2FA"] = "Annual Forb"
lpi_fun_sum$fun_grp[lpi_fun_sum$value == "2GP"] = "Perennial Grass"

com_table_fun = lpi_fun_sum %>% 
  group_by(point_id, year, fun_grp) %>% 
  summarise(n = sum(n)) %>% 
  pivot_wider(id_cols = c(point_id, year), names_from = fun_grp, values_from = n) %>% 
  mutate_all(~ replace_na(.x, 0)) %>% 
  select(-`NA`) 


```

## Separate by year and prep for depth
```{r}
data_18 = com_table %>% 
  filter(year == 2018)

data_21 = com_table %>% 
  filter(year == 2021)

data_16 = com_table %>% 
  filter(year == 2016)

data_15 = com_table %>% 
  filter(year == 2014)

points_18 = data_18$point_id

new_com_table = data_18 %>% 
  ungroup() %>% 
  mutate(id = paste(point_id, "10", sep = "-")) %>% 
  column_to_rownames("id") %>% 
  select(-point_id, -year) %>% 
  decostand(method = "total")

new_com_table10 = data_18 %>% 
  ungroup() %>% 
  mutate(id = paste(point_id, "10", sep = "-")) %>% 
  column_to_rownames("id") %>% 
  select(-point_id, -year) %>% 
  decostand(method = "total")

new_com_table40 = data_18 %>% 
  ungroup() %>% 
  mutate(id = paste(point_id, "40", sep = "-")) %>% 
  column_to_rownames("id") %>% 
  select(-point_id, -year) %>% 
  decostand(method = "total")


```




```{r}
com_change_table18 = com_table %>% 
  filter(year == 2018 | year < 2018) %>% 
  group_by(point_id) %>% 
  filter(n() > 1) %>% 
  mutate(id = paste(point_id, year, sep = "-")) %>% 
  column_to_rownames("id") %>% 
  ungroup() %>% 
  select(-point_id, - year) %>% 
  decostand(method = "total")

year_dist18 = vegdist(com_change_table18, method = "bray") %>% 
  as.matrix() %>% 
  as.data.frame() %>% 
  rownames_to_column() %>% 
  filter(str_detect(rowname, "2016")) %>% 
  column_to_rownames("rowname") %>% 
  select(contains("2018")) %>% 
  as.matrix()

veg_point_distance18 = data_frame(distance = diag(year_dist18)) %>% 
  mutate(points = rownames(year_dist18))
```
## Summarize community change

```{r}

com_change_table = com_table %>% 
  filter(year == 2018 | year == 2021) %>% 
  group_by(point_id) %>% 
  filter(n() > 1) %>% 
  mutate(id = paste(point_id, year, sep = "-")) %>% 
  column_to_rownames("id") %>% 
  ungroup() %>% 
  select(-point_id, - year) %>% 
  decostand(method = "total")

year_dist = vegdist(com_change_table, method = "bray") %>% 
  as.matrix() %>% 
  as.data.frame() %>% 
  rownames_to_column() %>% 
  filter(str_detect(rowname, "2018")) %>% 
  column_to_rownames("rowname") %>% 
  select(contains("2021")) %>% 
  as.matrix()

veg_point_distance = data_frame(distance = diag(year_dist)) %>% 
  mutate(points = rownames(year_dist))

```

```{r}
top_species = new_com_table %>% 
  rownames_to_column() %>% 
  pivot_longer(-rowname) %>% 
  group_by(name) %>% 
  summarise(total = sum(value))
```

```{r}
com_table21_change = data_21 %>% 
  column_to_rownames("point_id") %>% 
  select(-year) %>% 
  decostand(method = "total")

com_table18_change = data_18 %>% 
  column_to_rownames("point_id") %>% 
  select(-year) %>% 
  decostand(method = "total") %>% 
  filter(rownames(.) %in% rownames(com_table21_change))

veg_change_com = com_table21_change - com_table18_change

````




#Bacterial Analyses

```{r}

otu_standard_match = otu_standard %>% 
  filter(rownames(.) %in% rownames(toka_c_points))

otu_standard_match10 = otu_standard %>% 
  filter(rownames(.) %in% rownames(change10)) %>% 
  as.data.frame()

otu_standard_match40 = otu_standard %>% 
  filter(rownames(.) %in% rownames(change40)) %>% 
  as.data.frame()

```


## Diversity

### calculate diversity

```{r}
microbe_diversity = diversity(otu_standard_match) %>% 
  as.data.frame() %>% 
  clean_names() %>% 
  rename(diversity = x)

microbe_richness = specnumber(otu_standard_match) %>% 
  as.data.frame() %>% 
  clean_names() %>% 
  rename(richness = x)

microbe_diversity_soil = microbe_diversity %>% 
  rownames_to_column() %>% 
  left_join(microbe_richness %>% rownames_to_column(), by = "rowname") %>% 
  left_join(toka_c_points %>% rownames_to_column(), by = "rowname")
  
richness_sum = microbe_diversity_soil %>% 
  group_by(depth) %>% 
  summarize(richness_mean = mean(richness), richness_sd = sd(richness))

microbe_diversity_soil10 = microbe_diversity_soil %>% 
  filter(depth == 10)

microbe_diversity_soil40 = microbe_diversity_soil %>% 
  filter(depth == 40)


print(richness_sum)
```

### diversity linear models
```{r}
divmod_surf = lm(`2018` ~ richness, data = microbe_diversity_soil10) # not significant <----
summary(divmod_surf)

divmod_depth = lm(`2018` ~ richness, data = microbe_diversity_soil40) #not significant
summary(divmod_depth)


divmod_surf_change = lm(change18 ~ richness, data = microbe_diversity_soil10) #not significant
summary(divmod_surf_change)

divmod_depth_change = lm(change18 ~ richness, data = microbe_diversity_soil40) #not significant
summary(divmod_depth_change)


divmod_surf_future = lm(change21 ~ richness, data = microbe_diversity_soil10) #not significant
summary(divmod_surf_future)

divmod_depth_future = lm(change21 ~ richness, data = microbe_diversity_soil40) #marginally significant
summary(divmod_depth_future)

future_depth = lm(change21 ~ depth, data = microbe_diversity_soil)
summary(future_depth)

divmod_future = lm(change21 ~ richness + depth, data = microbe_diversity_soil) #significant <----
summary(divmod_future)

divmod_future_int = lm(change21 ~ richness*depth, data = microbe_diversity_soil) #significant but worse
summary(divmod_future_int)

AIC(future_depth, divmod_future, divmod_future_int)


divmod_current = lm(`2018` ~ richness + depth, data = microbe_diversity_soil) #significant
summary(divmod_current)

divmod_current_depth = lm(`2018` ~ depth, data = microbe_diversity_soil)
summary(divmod_current_depth)

AIC(divmod_current, divmod_current_depth)

divmod_current_int = lm(`2018` ~ richness*depth, data = microbe_diversity_soil) #significant but worse
summary(divmod_current_int)

AIC(divmod_current, divmod_current_int)

```

```{r}
plot(divmod_future)

```
### Diversity plots
```{r}

(bact_richness = ggplot(microbe_diversity_soil, aes(x = richness, y = `2018`)) +
  geom_point() +
  facet_wrap(. ~ depth_text) +
  geom_smooth(method = "lm", linetype = "dashed", color = "black") +
  # scale_color_manual(values = c("darkgreen", "purple"),  labels = c("0-10 cm", "10-40 cm"), name = "Depth") +
  theme_bw() +
  ylab("% SOC 2018") +
  xlab("ASV Richness 2018"))

ggsave(here::here("documents/figures/bact_richness_soc.png"), dpi = 300, plot = bact_richness, device = "png", width = 8, height = 6)

```

```{r}

(bact_richness_change = ggplot(microbe_diversity_soil, aes(x = richness, y = change21)) +
  geom_point() +
  facet_wrap(. ~ depth_text) +
  geom_smooth(method = "lm", linetype = "dashed", color = "black") +
  # scale_color_manual(values = c("darkgreen", "purple"), name = "Depth") +
  theme_bw() +
  ylab("Change % SOC 2018-2021") +
  xlab("ASV richness"))

ggsave(here::here("documents/figures/bact_richness_future_change.png"), dpi = 300, plot = bact_richness_change, device = "png", width = 8, height = 6)


```

## NMDS ALL


```{r}
NMS16S = metaMDS(otu_standard_match, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE, autotransform = FALSE)

```
```{r}

scores_16s = as.data.frame(scores(NMS16S))

change_mat = toka_c_points %>% 
  select(change18, `2018`, change18, change21, depth) %>% 
  filter(rownames(.) %in% rownames(scores_16s))

change_mat_complete = change_mat %>% 
  select(depth, change18, `2018`)



depth_scores = envfit(scores_16s, change_mat, nperm = 999, na.rm = T)
depth_scores_plot = as.data.frame(scores(depth_scores, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C",
                              rowname == "c_pc_change" ~ "% Carbon Change (Relative)",
                              rowname == "cn_change" ~ "C:N ratio change",
                              rowname == "n_2018" ~ "% Nitrogen",
                              rowname == "c_n_ratio" ~ "C:N ratio",
                              rowname == "change21" ~ "Future % Change",
                              rowname == "sand" | rowname == "silt" | rowname == "clay" ~ rowname))

# = data.frame(depth_scores$vectors$arrows * sqrt(depth_scores$vectors$r))

depth_scores_complete = envfit(scores_16s, change_mat_complete, nperm = 999, na.rm = T)
depth_scores_plot_complete = as.data.frame(scores(depth_scores_complete, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C",
                              rowname == "c_pc_change" ~ "% Carbon Change (Relative)",
                              rowname == "cn_change" ~ "C:N ratio change",
                              rowname == "n_2018" ~ "% Nitrogen",
                              rowname == "c_n_ratio" ~ "C:N ratio",
                              rowname == "change21" ~ "Future % Change",
                              rowname == "sand" | rowname == "silt" | rowname == "clay" ~ rowname))

fam_16_env = envfit(scores_16s, family_standard, nperm = 999, na.rm = TRUE)
fam_16_scores = as.data.frame(scores(fam_16_env, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(phylum = str_replace(rowname, "p__", ""))

scores_16s_data = as.data.frame(scores(NMS16S)) %>%
  rownames_to_column() %>% 
  left_join(change_mat_complete %>% rownames_to_column(), by = "rowname") %>% 
  mutate(depth_cm = as.factor(depth))

surface_grp = scores_16s_data[scores_16s_data$depth == 10,][chull(scores_16s_data[scores_16s_data$depth_cm == 10, c("NMDS1", "NMDS2")]),]

depth_grp = scores_16s_data[scores_16s_data$depth_cm == 40,][chull(scores_16s_data[scores_16s_data$depth_cm == 40, c("NMDS1", "NMDS2")]),]

hull_data = rbind(surface_grp, depth_grp)

NMDS.mean=aggregate(scores_16s_data[,1:2],list(group=scores_16s_data$depth_cm),mean)


veganCovEllipse<-function (cov, center = c(0, 0), scale = 1, npoints = 100) 
{
  theta <- (0:npoints) * 2 * pi/npoints
  Circle <- cbind(cos(theta), sin(theta))
  t(center + scale * t(Circle %*% chol(cov)))
}

df_ell <- data.frame()
for(g in levels(scores_16s_data$depth_cm)){
  df_ell <- rbind(df_ell, cbind(as.data.frame(with(scores_16s_data[scores_16s_data$depth_cm==g,],
                                                   veganCovEllipse(cov.wt(cbind(NMDS1,NMDS2),wt=rep(1/length(NMDS1),length(NMDS1)))$cov,center=c(mean(NMDS1),mean(NMDS2)))))
                                ,group=g))
}

```
### plot
```{r}
(bact_nmds_all = ggplot(scores_16s_data, aes(NMDS1, NMDS2)) +
  geom_point(aes(color = depth_cm), size = 4) +
  geom_path(data = df_ell, aes(x = NMDS1, y = NMDS2, color = group), size = 1, linetype = 2) +
  scale_color_manual(values = c("darkgreen", "purple"), labels = c("0-10 cm", "10-40cm"), name = "Depth") + 
  scale_fill_manual(values = c("darkgreen", "purple"), labels = c("0-10 cm", "10-40cm"), name = "Depth") +
  geom_text(data = fam_16_scores, mapping = aes(x = NMDS1, y = NMDS2, label = phylum), color = "black", size = 3) +
  geom_text(aes(label = paste("stress = ", round(NMS16S$stress, 3)), x = 0.8, y = -.9), size = 4, color = "black") +
  theme_bw() +
  xlim(-.9, 1))

ggsave(here::here("documents/figures/bact_NMDS_all.png"), dpi = 300, plot = bact_nmds_all, device = "png", width = 8, height = 6)

```
## NMDS 10

```{r}
NMDS_16S_10 = metaMDS(otu_standard_match10, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)
NMDS_16S_10
```

###envfit

```{r}
scores_16s_10 = as.data.frame(scores(NMDS_16S_10))

change10_complete = change10 %>% 
  filter(rownames(.) %in% rownames(scores_16s_10)) %>% 
  select(change18, `2018`)


depth_scores10_complete = envfit(scores_16s_10, change10_complete, nperm = 999, na.rm = T)



depth_scores_plot10_complete = as.data.frame(scores(depth_scores10_complete, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C (2018)"))


family_standard_10 = family_standard %>% 
  filter(rownames(.) %in% rownames(change10)) %>% 
  select_if(colSums(.) != 0)

fam_16_env10 = envfit(scores_16s_10, family_standard_10, nperm = 999)
fam_16_scores10 = as.data.frame(scores(fam_16_env10, display = "vectors")) %>% 
  rownames_to_column() %>% 
  left_join(as.data.frame(fam_16_env10$vectors$pvals) %>% rownames_to_column(), by = "rowname") %>% 
  mutate(phylum = str_replace(rowname, "p__", "")) %>% 
  filter(`fam_16_env10$vectors$pvals` <= 0.05)

scores_16s_10 = as.data.frame(scores(NMDS_16S_10)) %>% 
  rownames_to_column() %>% 
  left_join(change10_complete %>% rownames_to_column(), by = "rowname") 


```



### no outlier
```{r}
ff = change10 %>% 
  filter(`2018` < 7) %>% 
  filter(rownames(.) %in% rownames(otu_standard_match10)) %>% 
  select(`2018`, change18)

otu10_no_outlier = otu_standard_match10 %>% 
  filter(rownames(.) %in% rownames(ff))

family_no_outlier = family_standard_10 %>% 
  filter(rownames(.) %in% rownames(ff))

NMDS_16S_10_no = metaMDS(otu10_no_outlier, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)
NMDS_16S_10_no


```



```{r}
scores_16s_10_no = as.data.frame(scores(NMDS_16S_10_no))

depth_scores10_complete_no = envfit(scores_16s_10_no, ff, nperm = 999, na.rm = T)
depth_scores_plot10_complete_no = as.data.frame(scores(depth_scores10_complete_no, display = "vectors")) %>% 
  rownames_to_column() %>% 
   mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C (2018)",
                              rowname == "c_pc_change" ~ "% Carbon Change (Relative)",
                              rowname == "cn_change" ~ "C:N ratio change",
                              rowname == "n_2018" ~ "% Nitrogen",
                              rowname == "c_n_ratio" ~ "C:N ratio",
                              rowname == "change21" ~ "Future % Change",
                              rowname == "sand" | rowname == "silt" | rowname == "clay" ~ rowname)) %>% 
  filter(rowname %in% c( "change18", "2018" , "change21"))

family_standard_10_no = family_no_outlier%>% 
  select_if(colSums(.) != 0)

fam_16_env10_no = envfit(scores_16s_10_no, family_standard_10_no, nperm = 999)
fam_16_scores10_no = as.data.frame(scores(fam_16_env10_no, display = "vectors")) %>% 
  rownames_to_column() %>% 
  left_join(as.data.frame(fam_16_env10_no$vectors$pvals) %>% rownames_to_column(), by = "rowname") %>% 
  mutate(phylum = str_replace(rowname, "p__", "")) %>% 
  filter(`fam_16_env10_no$vectors$pvals` <= 0.05 )

scores_16s_10_no = as.data.frame(scores(NMDS_16S_10_no)) %>% 
  rownames_to_column() %>% 
  left_join(ff %>% rownames_to_column(), by = "rowname") 

```


### plots
```{r}
(plot16s_10 = ggplot(scores_16s_10, aes(NMDS1, NMDS2, color = `2018`)) +
  geom_point(size = 3) +
  geom_segment(data = depth_scores_plot10_complete, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_plot10_complete, aes(label = variable),
            size = 4, color = "black") +
  geom_text(data = fam_16_scores10, mapping = aes(x = NMDS1, y = NMDS2, label = phylum), color = "blue") +
  scale_color_viridis_b(name = "% Organic C") +
  geom_text(aes(label = paste("stress = ", round(NMDS_16S_10$stress, 3)), x = -0.8, y = -.6), size = 4, color = "black") + 
  theme_bw()+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill="white"))) 

```

```{r}
(plot16s_10_no = ggplot(scores_16s_10_no, aes(NMDS1, NMDS2, color = `2018`)) +
  geom_point(size = 3) +
  geom_segment(data = depth_scores_plot10_complete_no, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_plot10_complete_no, aes(label = variable),
            size = 4, color = "black") +
  geom_text(data = fam_16_scores10_no, mapping = aes(x = NMDS1, y = NMDS2, label = phylum), color = "blue") +
  scale_color_viridis_b(name = "% Organic C") +
  geom_text(aes(label = paste("stress = ", round(NMDS_16S_10_no$stress, 3)), x = -0.8, y = -.6), size = 4, color = "black") + 
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill="white")))
```
### statisic report
```{r}
depth_scores10_complete
depth_scores10_complete_no

```

## NMDS 40

```{r}

NMDS_16S_40 = metaMDS(otu_standard_match40, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)
NMDS_16S_40

```


### envfit
```{r}
scores_16s_40 = as.data.frame(scores(NMDS_16S_40))

change40_complete = change40 %>% 
  filter(rownames(.) %in% rownames(scores_16s_40)) %>% 
  select(change18, `2018`)

depth_scores40_complete = envfit(scores_16s_40, change40_complete, nperm = 999, na.rm = T)
depth_scores_plot40_complete = as.data.frame(scores(depth_scores40_complete, display = "vectors")) %>% 
  rownames_to_column() %>% 
   mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C"))

family_standard_40 = family_standard %>% 
  filter(rownames(.) %in% rownames(change40)) %>% 
  select_if(colSums(.) != 0)

fam_16_env40 = envfit(scores_16s_40, family_standard_40, nperm = 999)
fam_16_scores40 = as.data.frame(scores(fam_16_env40, display = "vectors")) %>% 
  rownames_to_column() %>% 
  left_join(as.data.frame(fam_16_env40$vectors$pvals) %>% rownames_to_column(), by = "rowname") %>% 
  mutate(phylum = str_replace(rowname, "p__", "")) %>% 
  filter(`fam_16_env40$vectors$pvals` <= 0.05)


scores_16s_40 = as.data.frame(scores(NMDS_16S_40)) %>% 
  rownames_to_column() %>%
  left_join(change40_complete %>% rownames_to_column(), by = "rowname")

```


### no outlier

```{r}

ff40 = change40_complete %>% filter(`2018` < 5)

otu40_no_outlier = otu_standard_match40 %>% 
  filter(rownames(.) %in% rownames(ff40))

family_no_outlier40 = family_standard_40 %>% 
  filter(rownames(.) %in% rownames(ff40))



NMDS_16S_40_no = metaMDS(otu40_no_outlier, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)
NMDS_16S_40_no
```


```{r}
scores_16s_40_no = as.data.frame(scores(NMDS_16S_40_no))

depth_scores40_complete_no = envfit(scores_16s_40_no, ff40, nperm = 999, na.rm = T)
depth_scores_plot40_complete_no = as.data.frame(scores(depth_scores40_complete_no, display = "vectors")) %>% 
  rownames_to_column() %>% 
   mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C (2018)"))


family_standard_40_no = family_no_outlier40%>% 
  select_if(colSums(.) != 0)

fam_16_env40_no = envfit(scores_16s_40_no, family_standard_40_no, nperm = 999)
fam_16_scores40_no = as.data.frame(scores(fam_16_env40_no, display = "vectors")) %>% 
  rownames_to_column() %>% 
  left_join(as.data.frame(fam_16_env40_no$vectors$pvals) %>% rownames_to_column(), by = "rowname") %>% 
  mutate(phylum = str_replace(rowname, "p__", "")) %>% 
  filter(`fam_16_env40_no$vectors$pvals` <= 0.05)

scores_16s_40_no = as.data.frame(scores(NMDS_16S_40_no)) %>% 
  rownames_to_column() %>% 
  left_join(ff40 %>% rownames_to_column(), by = "rowname") 
```

### plots

```{r}

(plot16s_40 = ggplot(scores_16s_40, aes(NMDS1, NMDS2, color = `2018`)) +
  geom_point(size = 3) +
  geom_segment(data = depth_scores_plot40_complete, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_plot40_complete, aes(label = variable),
            size = 4, color = "black") +
  geom_text(data = fam_16_scores40, mapping = aes(x = NMDS1, y = NMDS2, label = phylum), color = "blue") +
  scale_color_viridis_c(name = "% Organic C") +
  geom_text(aes(label = paste("stress = ", round(NMDS_16S_40$stress, 3)), x = 0.8, y = -.7), size = 4, color = "black") + 
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill="white")) ) 


```

```{r}
(plot16s_40_no = ggplot(scores_16s_40_no, aes(NMDS1, NMDS2, color = `2018`)) +
  geom_point(size = 3) +
  geom_segment(data = depth_scores_plot40_complete_no, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_plot40_complete_no, aes(label = variable),
            size = 4, color = "black") +
  geom_text(data = fam_16_scores40_no, mapping = aes(x = NMDS1, y = NMDS2, label = phylum), color = "blue") +
  scale_color_viridis_b(name = "% Organic C")  +
  geom_text(aes(label = paste("stress = ", round(NMDS_16S_40_no$stress, 3)), x = -0.6, y = -.6), size = 4, color = "black") + 
  theme_bw()+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill="white"))) 
```

### statisic report
```{r}
depth_scores40_complete
depth_scores40_complete_no

```
## final NMDS figures

```{r}
(bact_NMDS_all = ggarrange(plot16s_10, plot16s_40, common.legend = F, legend = "right", ncol = 1, labels = "AUTO")  +
  theme(axis.title = element_text(size = 12)))

(bact_NMDS_all_no_outlier = ggarrange(plot16s_10_no, plot16s_40_no, common.legend =F, legend = "right", ncol = 1, labels = "AUTO")  +
  theme(axis.title = element_text(size = 12)))


ggsave(here::here("documents/figures/bact_NMDS_all.png"), dpi = 300, plot = bact_NMDS_all, device = "png", width = 8, height = 12)

ggsave(here::here("documents/figures/bact_NMDS_all_no_outlier.png"), dpi = 300, plot = bact_NMDS_all_no_outlier, device = "png", width = 8, height = 12)

```





##NMDS Future

### Surface

```{r}
otu_future10 = otu_standard %>% 
  filter(rownames(.) %in% rownames(change10_future))

change10_future_16 = change10_future %>% 
  filter(rownames(.) %in% rownames(otu_future10)) %>% 
  select(change21)

```


```{r}

NMDS_16S_future10 = metaMDS(otu_future10, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)

NMDS_16S_future10

```



```{r}


scores_16s_future10 = as.data.frame(scores(NMDS_16S_future10))


depth_scores_future10 = envfit(scores_16s_future10, change10_future_16, nperm = 999, na.rm = T)

depth_scores_plot_future10 = as.data.frame(scores(depth_scores_future10, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change21" ~ "Future % Change"))


scores_16s_future10 = as.data.frame(scores(NMDS_16S_future10)) %>% 
  rownames_to_column() %>% 
  left_join(change10_future_16 %>% rownames_to_column(), by = "rowname")

```

#### plot

```{r}
ggplot(scores_16s_future10, aes(NMDS1, NMDS2)) +
  geom_point(aes(color = change21), size = 4) +
  geom_segment(data = depth_scores_plot_future10, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_plot_future10, aes(x = NMDS1, y = NMDS2, label = variable),
            size = 6) +
  theme_bw()

```
#### stats
```{r}
depth_scores_future10

```

### Depth

```{r}
otu_future40 = otu_standard %>% 
  filter(rownames(.) %in% rownames(change40_future))

change40_future_16 = change40_future %>% 
  filter(rownames(.) %in% rownames(otu_future40)) %>% 
  select(change21)

```


```{r}

NMDS_16S_future40 = metaMDS(otu_future40, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)

NMDS_16S_future40

```



```{r}


scores_16s_future40 = as.data.frame(scores(NMDS_16S_future40))


depth_scores_future40 = envfit(scores_16s_future40, change40_future_16, nperm = 999, na.rm = T)

depth_scores_plot_future40 = as.data.frame(scores(depth_scores_future40, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change21" ~ "Future % Change"))


scores_16s_future40 = as.data.frame(scores(NMDS_16S_future40)) %>% 
  rownames_to_column() %>% 
  left_join(change40_future_16 %>% rownames_to_column(), by = "rowname")

```

#### plot

```{r}
ggplot(scores_16s_future40, aes(NMDS1, NMDS2)) +
  geom_point(aes(color = change21), size = 4) +
  geom_segment(data = depth_scores_plot_future40, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_plot_future40, aes(x = NMDS1, y = NMDS2, label = variable),
            size = 6) +
  theme_bw()

```

#### stats
```{r}
depth_scores_future40

```
## Taxonomic Composition
```{r}

depth_key = toka_c_points %>% 
  select(depth) %>% 
  rownames_to_column %>% 
  mutate(depth_text = case_when(depth == 10 ~ "0-10 cm",
                           depth == 40 ~ "10-40 cm"))

fam_carbon_10 = family_standard_10 %>% 
  rownames_to_column() %>% 
  left_join(toka_c_points %>% select(`2018`, change18, change21) %>% rownames_to_column(), by = "rowname") %>% 
  column_to_rownames("rowname")


fam_carbon_40 = family_standard_40 %>% 
  rownames_to_column() %>% 
  left_join(toka_c_points %>% select(`2018`, change18, change21) %>% rownames_to_column(), by = "rowname") %>% 
  column_to_rownames("rowname")

fam_carbon = family_standard %>% 
  rownames_to_column() %>% 
  left_join(toka_c_points %>% select(`2018`, change18, change21) %>% rownames_to_column(), by = "rowname") %>% 
  left_join(depth_key, by = "rowname") %>% 
  column_to_rownames("rowname")

fam_pivot_10 = family_standard_10 %>% 
  select_if(colSums(.) != 0) %>%
  rownames_to_column() %>%
  pivot_longer(-rowname)

bottom_taxa = family_standard %>% 
  select(-p__Verrucomicrobia, -p__Acidobacteria, -p__Proteobacteria, -p__Bacteroidetes, -p__Planctomycetes, -p__Actinobacteria, -p__Gemmatimonadetes, -p__Firmicutes, -p__Chloroflexi) %>% 
  mutate(other = rowSums(.)) %>% 
  rownames_to_column() %>% 
  select(rowname, other)

top_taxa = family_standard %>% 
  select(p__Verrucomicrobia, p__Acidobacteria, p__Proteobacteria, p__Bacteroidetes, p__Planctomycetes, p__Actinobacteria, p__Gemmatimonadetes, p__Firmicutes, p__Chloroflexi) %>% 
  rownames_to_column() %>% 
  left_join(bottom_taxa, by = "rowname")

top_taxa_3 = family_standard %>% 
  select(p__Verrucomicrobia, p__Acidobacteria, p__Proteobacteria, p__Bacteroidetes,  p__Actinobacteria,  p__Gemmatimonadetes) %>% 
  mutate(total = rowSums(.))
  

top_taxa_pivot = top_taxa %>%
  left_join(depth_key, by = "rowname")%>% 
  mutate(point_id = substr(rowname, 1, nchar(rowname)-3))%>% 
  select(-rowname) %>% 
  pivot_longer(c(-point_id, -depth, - depth_text))%>% 
  mutate(phylum = factor(str_replace(name, "p__", ""), levels = rev(c("Verrucomicrobia", "Acidobacteria", "Proteobacteria", "Bacteroidetes", "Planctomycetes", "Actinobacteria", "Gemmatimonadetes", "Firmicutes", "Chloroflexi", "other")) ))


```

### Plot
```{r}
library(calecopal)

top_taxa_pivot_10 = top_taxa_pivot %>% 
  filter(depth == 10)

top_taxa_pivot_40 = top_taxa_pivot %>% 
  filter(depth == 40)

ggplot(top_taxa_pivot, aes(x = point_id, y = value, fill = phylum)) +
  geom_col() +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill="white")) +
  facet_grid(depth_text ~ .) +
  scale_fill_manual(name = "Phylum", values = rev(cal_palette("superbloom3", n = 10, type = "continuous"))) +
  xlab("Sample Point") +
  ylab("Relative Abundance")


```


## Functional Groups

Sort into functional groups
```{r}

oligotroph = c("Verrucomicrobia", "Acidobacteria")
copiotroph = c("Proteobacteria", "Bacteroidetes", "Actinobacteria", "Gemmatimonadetes")

fam_carbon_function = fam_carbon %>% 
  mutate(oligotrophs = p__Verrucomicrobia + p__Acidobacteria,
         copiotrophs = p__Proteobacteria + p__Bacteroidetes + p__Actinobacteria + p__Gemmatimonadetes,
         c_o_ratio = copiotrophs/oligotrophs)

fam_carbon_function10 = fam_carbon_function %>% 
  filter(depth == 10)

fam_carbon_function40 = fam_carbon_function %>% 
  filter(depth == 40)

trait_sum =  fam_carbon_function %>% 
  group_by(depth) %>% 
  summarize(mean_c_o = mean(c_o_ratio),
            sd_c_o = sd(c_o_ratio),
            mean_C = mean(`2018`))

trait_sum

```


### statistics

#### Current SOC Regressions
```{r}


trait_mod10 = lm(`2018` ~ c_o_ratio, data = fam_carbon_function10)
summary(trait_mod10)

trait_mod10_no = lm(`2018` ~ c_o_ratio, data = fam_carbon_function10 %>% filter(`2018` < 7))
summary(trait_mod10_no)

trait_mod40 = lm(`2018` ~ c_o_ratio, data = fam_carbon_function40)
summary(trait_mod40)

trait_mod40_no = lm(`2018` ~ c_o_ratio, data = fam_carbon_function40 %>% filter(`2018` < 5))
summary(trait_mod40_no)

# trait_mod = lm(log(`2018`) ~  c_o_ratio*depth_cm, data = fam_carbon_function)

# trait_mod1 = lm(log(`2018`) ~  c_o_ratio*depth_cm, data = fam_carbon_function, weights = fam_carbon_function$copiotrophs + fam_carbon_function$oligotrophs)
# summary(trait_mod)


plot(trait_mod10_no)

```

#### Recent changes
```{r}

trait_mod10 = lm(change18 ~ c_o_ratio, data = fam_carbon_function10)
summary(trait_mod10)


trait_mod40 = lm(change18 ~ c_o_ratio, data = fam_carbon_function40)
summary(trait_mod40)


```

#### Future changes
```{r}

trait_mod10 = lm(change21 ~ c_o_ratio, data = fam_carbon_function10)
summary(trait_mod10)


trait_mod40 = lm(change21 ~ c_o_ratio, data = fam_carbon_function40)
summary(trait_mod40)


```
### plots

```{r}
(function_16S_plot = ggplot(fam_carbon_function, (aes(x = c_o_ratio, y = `2018`))) +
  geom_point() +
  theme_bw() +
  facet_grid(. ~ depth_text) +
  scale_color_manual(values = c("darkgreen", "purple"), name = "Depth") +
  theme(axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill="white")) +
  # geom_smooth(data = fam_carbon_function %>% filter(depth_cm == "0 to 10"), method = "lm", fill = "darkgreen", alpha = 0.1) +
  geom_smooth(method = "lm", color = "black", linetype = "dashed") +
  ylab("% Organic Carbon") +
  xlab("Copiotroph:Oligotroph Ratio"))

ggsave(here::here("documents/figures/bact_function_2018.png"), dpi = 300, plot = function_16S_plot, device = "png", width = 8, height = 6)




```

```{r}
(function_16S_plot_future = ggplot(fam_carbon_function, (aes(x = c_o_ratio, y = change21))) +
  geom_point() +
  theme_bw() +
  facet_grid(. ~ depth_text) +
  scale_color_manual(values = c("darkgreen", "purple"), name = "Depth") +
  theme(axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill="white")) +
  # geom_smooth(data = fam_carbon_function %>% filter(depth_cm == "0 to 10"), method = "lm", fill = "darkgreen", alpha = 0.1) +
  geom_smooth(method = "lm", color = "black", linetype = "dashed") +
  ylab("Change % Organic Carbon 2018-2021") +
  xlab("Copiotroph:Oligotroph Ratio"))


ggsave(here::here("documents/figures/bact_function_future.png"), dpi = 300, plot = function_16S_plot_future, device = "png", width = 8, height = 6)

```

```{r}
(function_16S_plot_recent = ggplot(fam_carbon_function, (aes(x = c_o_ratio, y = change18))) +
  geom_point() +
  theme_bw() +
  facet_grid(. ~ depth_text) +
  scale_color_manual(values = c("darkgreen", "purple"), name = "Depth") +
  theme(axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill="white")) +
  # geom_smooth(data = fam_carbon_function %>% filter(depth_cm == "0 to 10"), method = "lm", fill = "darkgreen", alpha = 0.1) +
  geom_smooth(method = "lm", color = "black", linetype = "dashed") +
  ylab("Change % Organic Carbon 2018-2021") +
  xlab("Copiotroph:Oligotroph Ratio"))


```

# Fungal Analyses


## Diversity
```{r}

fungal_diversity = diversity(asv_all) %>% 
  as.data.frame() %>% 
  clean_names() %>% 
  rename(diversity = x)

fungal_richness = specnumber(asv_all) %>% 
  as.data.frame() %>% 
  clean_names() %>% 
  rename(richness = x)

fungal_diversity_soil = fungal_diversity %>% 
  rownames_to_column() %>% 
  left_join(fungal_richness %>% rownames_to_column(), by = "rowname") %>% 
  left_join(toka_c_points %>% rownames_to_column(), by = "rowname")

fungal_richness_sum = fungal_diversity_soil %>% 
  group_by(depth) %>% 
  summarize(richness_mean = mean(richness, na.rm = T), richness_sd = sd(richness, na.rm = T))

fungal_diversity_soil10 = fungal_diversity_soil %>% 
  filter(depth == 10)

fungal_diversity_soil40 = fungal_diversity_soil %>% 
  filter(depth == 40)


print(fungal_richness_sum)
```



```{r}

fung_surf_current = lm(`2018` ~ richness, data = fungal_diversity_soil10)
summary(fung_surf_current)

fung_surf_current_no = lm(`2018` ~ richness, data = fungal_diversity_soil10 %>% filter(`2018` < 7))
summary(fung_surf_current_no)

fung_depth_current = lm(`2018` ~ richness, data = fungal_diversity_soil40)
summary(fung_depth_current)

fung_surf_recent = lm(change18 ~ richness, data = fungal_diversity_soil10)
summary(fung_surf_recent)

fung_depth_recent = lm(change18 ~ richness, data = fungal_diversity_soil40)
summary(fung_depth_recent)

fung_surf_future = lm(change21 ~ richness, data = fungal_diversity_soil10)
summary(fung_surf_future)

fung_depth_future = lm(change21 ~ richness, data = fungal_diversity_soil40)
summary(fung_depth_future)

```
```{r}
  plot(fung_surf_current_no)
```
### plot
```{r}

(fung_richness = ggplot(fungal_diversity_soil, aes(x = richness, y = `2018`)) +
  geom_point() +
  facet_wrap(. ~ depth_text) +
  geom_smooth(method = "lm", linetype = "dashed", color = "black") +
  # scale_color_manual(values = c("darkgreen", "purple"),  labels = c("0-10 cm", "10-40 cm"), name = "Depth") +
  theme_bw() +
  ylab("% SOC 2018") +
  xlab("Fungal ASV Richness 2018"))

ggsave(here::here("documents/figures/fungal_diversity_2018.png"), dpi = 300, plot = fung_richness, device = "png", width = 8, height = 6)


```

## NMDS ALL

```{r}
NMDS_fungal_all = metaMDS(asv_all, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE, autotransform = FALSE)

NMDS_fungal_all


```

```{r}

scores_fungal_all = as.data.frame(scores(NMDS_fungal_all))


depth_scores_fungus = envfit(scores_fungal_all, change_mat, nperm = 999, na.rm = T)
depth_scores_fungus_plot = as.data.frame(scores(depth_scores_fungus, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C",
                              rowname == "change21" ~ "Future % Change"))

depth_scores_fungus_complete = envfit(scores_fungal_all, change_mat_complete, nperm = 999, na.rm = T)


depth_scores_fungus_plot_complete = as.data.frame(scores(depth_scores_complete, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C",
                              rowname == "c_pc_change" ~ "% Carbon Change (Relative)",
                              rowname == "cn_change" ~ "C:N ratio change",
                              rowname == "n_2018" ~ "% Nitrogen",
                              rowname == "c_n_ratio" ~ "C:N ratio",
                              rowname == "change21" ~ "Future % Change",
                              rowname == "sand" | rowname == "silt" | rowname == "clay" ~ rowname))

function_fung = envfit(scores_fungal_all, fungal_func_sum, nperm = 999, na.rm = TRUE)
fung_function_scores = as.data.frame(scores(function_fung, display = "vectors")) %>% 
  rownames_to_column()

scores_fungal_all = as.data.frame(scores(NMDS_fungal_all)) %>% 
  rownames_to_column() %>% 
  left_join(change_mat_complete %>% rownames_to_column(), by = "rowname") %>% 
  mutate(depth_cm = as.factor(depth))

surface_grp_fung = scores_fungal_all[scores_fungal_all$depth == 10,][chull(scores_fungal_all[scores_fungal_all$depth_cm == 10, c("NMDS1", "NMDS2")]),]

depth_grp_fung = scores_fungal_all[scores_fungal_all$depth_cm == 40,][chull(scores_fungal_all[scores_fungal_all$depth_cm == 40, c("NMDS1", "NMDS2")]),]

hull_data = rbind(surface_grp_fung, depth_grp_fung)

NMDS.mean_fung = aggregate(scores_fungal_all[,1:2],list(group=scores_fungal_all$depth_cm),mean)


veganCovEllipse<-function (cov, center = c(0, 0), scale = 1, npoints = 100) 
{
  theta <- (0:npoints) * 2 * pi/npoints
  Circle <- cbind(cos(theta), sin(theta))
  t(center + scale * t(Circle %*% chol(cov)))
}

df_ell_fung <- data.frame()
for(g in levels(scores_fungal_all$depth_cm)){
  df_ell_fung <- rbind(df_ell_fung, cbind(as.data.frame(with(scores_fungal_all[scores_fungal_all$depth_cm==g,],
                                                   veganCovEllipse(cov.wt(cbind(NMDS1,NMDS2),wt=rep(1/length(NMDS1),length(NMDS1)))$cov,center=c(mean(NMDS1),mean(NMDS2)))))
                                ,group=g))
}

```

### plot

```{r}
ggplot(scores_fungal_all, aes(NMDS1, NMDS2)) +
  geom_point(aes(color = depth_cm), size = 4) +
  geom_path(data = df_ell_fung, aes(x = NMDS1, y = NMDS2, color = group), size = 1, linetype = 2) +
  scale_color_manual(values = c("darkgreen", "purple"), labels = c("0-10 cm", "10-40cm"), name = "Depth") + 
  scale_fill_manual(values = c("darkgreen", "purple"), labels = c("0-10 cm", "10-40cm"), name = "Depth") +
  geom_text(data = fung_function_scores, mapping = aes(x = NMDS1, y = NMDS2, label = rowname), color = "black", size = 3) +
  geom_text(aes(label = paste("stress = ", round(NMDS_fungal_all$stress, 3)), x = 0.4, y = -.4), size = 4, color = "black") +
  theme_bw()

```

## NMDS 10

```{r}
NMDS_fungal_10 = metaMDS(asv_10, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)
NMDS_fungal_10
```
### envfit



```{r}
scores_fungal_10 = as.data.frame(scores(NMDS_fungal_10))

depth_scores_fungal10_complete = envfit(scores_fungal_10, change10_complete, nperm = 999, na.rm = T)

depth_scores_fungal_plot10_complete = as.data.frame(scores(depth_scores_fungal10_complete, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C (2018)"))


fungal_func10 = fungal_func_sum %>% 
  filter(rownames(.) %in% rownames(scores_fungal_10))

fung_function10 = envfit(scores_fungal_10, fungal_func10, nperm = 999, na.rm = TRUE)

fung_function_scores10 = as.data.frame(scores(fung_function10, display = "vectors")) %>% 
  rownames_to_column() %>% 
  left_join(as.data.frame(fung_function10$vectors$pvals) %>% rownames_to_column(), by = "rowname") %>%
  filter(`fung_function10$vectors$pvals` <= .1 )

scores_fungal_10 = as.data.frame(scores(NMDS_fungal_10)) %>% 
  rownames_to_column() %>% 
  left_join(change10_complete %>% rownames_to_column(), by = "rowname") 


```



### no outlier

```{r}
asv_10_no = asv_10 %>% 
  filter(rownames(.) %in% rownames(ff))

NMDS_fungal_10_no = metaMDS(asv_10_no, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)
NMDS_fungal_10
```

```{r}
scores_fungal_10_no = as.data.frame(scores(NMDS_fungal_10_no))

depth_scores_fungal10_complete_no = envfit(scores_fungal_10_no, ff, nperm = 999, na.rm = T)

depth_scores_fungal_plot10_complete_no = as.data.frame(scores(depth_scores_fungal10_complete_no, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C (2018)"))


fungal_func10_no = fungal_func_sum %>% 
  filter(rownames(.) %in% rownames(scores_fungal_10_no))

fung_function10_no = envfit(scores_fungal_10_no, fungal_func10_no, nperm = 999, na.rm = TRUE)

fung_function_scores10_no = as.data.frame(scores(fung_function10_no, display = "vectors")) %>% 
  rownames_to_column() %>% 
  left_join(as.data.frame(fung_function10_no$vectors$pvals) %>% rownames_to_column(), by = "rowname") %>%
  filter(`fung_function10_no$vectors$pvals` <= .1 )

scores_fungal_10_no = as.data.frame(scores(NMDS_fungal_10_no)) %>% 
  rownames_to_column() %>% 
  left_join(ff %>% rownames_to_column(), by = "rowname") 


```

### plots

```{r}
(fung_plot10 = ggplot(scores_fungal_10, aes(NMDS1, NMDS2, color = `2018`)) +
  geom_point(size = 3) +
  geom_segment(data = depth_scores_fungal_plot10_complete, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_fungal_plot10_complete, aes(label = variable),
            size = 4, color = "black") +
  # geom_text(data = fung_function_scores10, mapping = aes(x = NMDS1, y = NMDS2, label = rowname), color = "blue") +
  scale_color_viridis_b(name = "% Organic C") +
  geom_text(aes(label = paste("stress = ", round(NMDS_fungal_10$stress, 3)), x = -0.4, y = -.6), size = 4, color = "black") +
  theme_bw())

```
```{r}
(fung_plot10_no = ggplot(scores_fungal_10_no, aes(NMDS1, NMDS2, color = `2018`)) +
  geom_point(size = 3) +
  geom_segment(data = depth_scores_fungal_plot10_complete_no, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_fungal_plot10_complete_no, aes(label = variable),
            size = 4, color = "black") +
  # geom_text(data = fung_function_scores10, mapping = aes(x = NMDS1, y = NMDS2, label = rowname), color = "blue") +
  scale_color_viridis_b(name = "% Organic C") +
  geom_text(aes(label = paste("stress = ", round(NMDS_fungal_10_no$stress, 3)), x = -0.4, y = -.6), size = 4, color = "black") +
  theme_bw())
```
### statistic report
```{r}
depth_scores_fungal10_complete
depth_scores_fungal10_complete_no

```
## NMDS 40

```{r}
NMDS_fungal_40 = metaMDS(asv_40, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)
NMDS_fungal_40
```


### envfit



```{r}

scores_fungal_40 = as.data.frame(scores(NMDS_fungal_40))

depth_scores_fungal40_complete = envfit(scores_fungal_40, change40_complete, nperm = 999, na.rm = T)

depth_scores_fungal_plot40_complete = as.data.frame(scores(depth_scores_fungal40_complete, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C (2018)"))


fungal_func40 = fungal_func_sum %>% 
  filter(rownames(.) %in% rownames(scores_fungal_40))

fung_function40 = envfit(scores_fungal_40, fungal_func40, nperm = 999, na.rm = TRUE)

fung_function_scores40 = as.data.frame(scores(fung_function40, display = "vectors")) %>% 
  rownames_to_column() %>% 
  left_join(as.data.frame(fung_function40$vectors$pvals) %>% rownames_to_column(), by = "rowname") %>%
  filter(`fung_function40$vectors$pvals` <= .1 )

scores_fungal_40 = as.data.frame(scores(NMDS_fungal_40)) %>% 
  rownames_to_column() %>% 
  left_join(change40_complete %>% rownames_to_column(), by = "rowname") 


```

### no outlier

```{r}
asv_40_no = asv_40 %>% 
  filter(rownames(.) %in% rownames(ff40))

NMDS_fungal_40_no = metaMDS(asv_40_no, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)
NMDS_fungal_40
```

```{r}
scores_fungal_40_no = as.data.frame(scores(NMDS_fungal_40_no))

depth_scores_fungal40_complete_no = envfit(scores_fungal_40_no, ff40, nperm = 999, na.rm = T)

depth_scores_fungal_plot40_complete_no = as.data.frame(scores(depth_scores_fungal40_complete_no, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change18" ~ "% Carbon Change",
                              rowname == "2018" ~ "% Organic C (2018)"))


fungal_func40_no = fungal_func_sum %>% 
  filter(rownames(.) %in% rownames(scores_fungal_40_no))

fung_function40_no = envfit(scores_fungal_40_no, fungal_func40_no, nperm = 999, na.rm = TRUE)

fung_function_scores40_no = as.data.frame(scores(fung_function40_no, display = "vectors")) %>% 
  rownames_to_column() %>% 
  left_join(as.data.frame(fung_function40_no$vectors$pvals) %>% rownames_to_column(), by = "rowname") %>%
  filter(`fung_function40_no$vectors$pvals` <= .1 )

scores_fungal_40_no = as.data.frame(scores(NMDS_fungal_40_no)) %>% 
  rownames_to_column() %>% 
  left_join(ff40 %>% rownames_to_column(), by = "rowname") 


```


### plots
```{r}
(fung_plot40 = ggplot(scores_fungal_40, aes(NMDS1, NMDS2, color = `2018`)) +
  geom_point(size = 3) +
  geom_segment(data = depth_scores_fungal_plot40_complete, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_fungal_plot40_complete, aes(label = variable),
            size = 4, color = "black") +
  # geom_text(data = fung_function_scores40, mapping = aes(x = NMDS1, y = NMDS2, label = rowname), color = "blue") +
  scale_color_viridis_b(name = "% Organic C") +
  geom_text(aes(label = paste("stress = ", round(NMDS_fungal_40$stress, 3)), x = -0.2, y = -.3), size = 4, color = "black") +
  theme_bw())

```

```{r}
(fung_plot40_no = ggplot(scores_fungal_40_no, aes(NMDS1, NMDS2, color = `2018`)) +
  geom_point(size = 3) +
  geom_segment(data = depth_scores_fungal_plot40_complete_no, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_fungal_plot40_complete_no, aes(label = variable),
            size = 4, color = "black") +
  # geom_text(data = fung_function_scores40, mapping = aes(x = NMDS1, y = NMDS2, label = rowname), color = "blue") +
  scale_color_viridis_b(name = "% Organic C") +
  geom_text(aes(label = paste("stress = ", round(NMDS_fungal_40_no$stress, 3)), x = -0.4, y = -.6), size = 4, color = "black") +
  theme_bw())
```


 ### statisic report

```{r}
depth_scores_fungal40_complete
depth_scores_fungal40_complete_no

```


## final NMDS figures

```{r}
(fung_NMDS_all = ggarrange(fung_plot10, fung_plot40, common.legend = F, legend = "right", ncol = 1, labels = "AUTO")  +
  theme(axis.title = element_text(size = 12)))

(fung_NMDS_all_no_outlier = ggarrange(fung_plot10_no, fung_plot40_no, common.legend =F, legend = "right", ncol = 1, labels = "AUTO")  +
  theme(axis.title = element_text(size = 12)))


ggsave(here::here("documents/figures/fung_NMDS_all.png"), dpi = 300, plot = fung_NMDS_all, device = "png", width = 8, height = 12)

ggsave(here::here("documents/figures/fung_NMDS_all_no_outlier.png"), dpi = 300, plot = fung_NMDS_all_no_outlier, device = "png", width = 8, height = 12)

```


##NMDS Future

### Surface

```{r}
asv_future10 = asv_10 %>% 
  filter(rownames(.) %in% rownames(change10_future))

change10_future_fung = change10_future %>% 
  filter(rownames(.) %in% rownames(asv_future10)) %>% 
  select(change21)

```


```{r}

NMDS_fungus_future10 = metaMDS(asv_future10, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)

NMDS_fungus_future10

```

```{r}


scores_fungus_future10 = as.data.frame(scores(NMDS_fungus_future10))


depth_scores_fungus_future10 = envfit(scores_fungus_future10, change10_future_16, nperm = 999, na.rm = T)

depth_scores_plot_fungus_future10 = as.data.frame(scores(depth_scores_fungus_future10, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change21" ~ "Future % Change"))


scores_fungus_future10 = as.data.frame(scores(NMDS_fungus_future10)) %>% 
  rownames_to_column() %>% 
  left_join(change10_future_16 %>% rownames_to_column(), by = "rowname")

```

#### plot

```{r}
ggplot(scores_fungus_future10, aes(NMDS1, NMDS2)) +
  geom_point(aes(color = change21), size = 4) +
  geom_segment(data = depth_scores_plot_fungus_future10, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_plot_fungus_future10, aes(x = NMDS1, y = NMDS2, label = variable),
            size = 6) +
  theme_bw()

```

####stats

```{r}
depth_scores_fungus_future10

```

### Depth


```{r}
asv_future40 = asv_40 %>% 
  filter(rownames(.) %in% rownames(change40_future))

change40_future_fung = change40_future %>% 
  filter(rownames(.) %in% rownames(asv_future40)) %>% 
  select(change21)

```


```{r}

NMDS_fungus_future40 = metaMDS(asv_future40, distance = "bray", k = 2, maxit = 999, trymax = 500, wascores = TRUE)

NMDS_fungus_future40

```

```{r}


scores_fungus_future40 = as.data.frame(scores(NMDS_fungus_future40))


depth_scores_fungus_future40 = envfit(scores_fungus_future40, change40_future_16, nperm = 999, na.rm = T)

depth_scores_plot_fungus_future40 = as.data.frame(scores(depth_scores_fungus_future40, display = "vectors")) %>% 
  rownames_to_column() %>% 
  mutate(variable = case_when(rowname == "change21" ~ "Future % Change"))


scores_fungus_future40 = as.data.frame(scores(NMDS_fungus_future40)) %>% 
  rownames_to_column() %>% 
  left_join(change40_future_16 %>% rownames_to_column(), by = "rowname")

```

#### plot

```{r}
ggplot(scores_fungus_future40, aes(NMDS1, NMDS2)) +
  geom_point(aes(color = change21), size = 4) +
  geom_segment(data = depth_scores_plot_fungus_future40, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               color = "blue", 
               arrow = arrow(length = unit(0.25, "cm"))) +
  geom_text(data = depth_scores_plot_fungus_future40, aes(x = NMDS1, y = NMDS2, label = variable),
            size = 6) +
  theme_bw()

```

#### stats

```{r}
depth_scores_fungus_future40

```

## Functional Groups

```{r}

## connect functional group composition to carbon data for analysis


fung_carbon = fungal_func_sum %>% 
  rownames_to_column() %>% 
  clean_names() %>% 
  left_join(toka_c_points %>% select(`2018`, change18, change21, depth, depth_text) %>% rownames_to_column(), by = "rowname") %>% 
  column_to_rownames("rowname") %>% 
  mutate(negative = pathotroph + saprotroph + pathotroph_saprotroph)


fung_carbon_10 = fungal_func10 %>% 
  rownames_to_column() %>% 
  clean_names() %>% 
  left_join(toka_c_points %>% select(`2018`, change18, change21) %>% rownames_to_column(), by = "rowname") %>% 
  column_to_rownames("rowname") %>% 
  mutate(negative = pathotroph + saprotroph + pathotroph_saprotroph)


fung_carbon_40 = fungal_func40 %>% 
  rownames_to_column() %>% 
  clean_names() %>% 
  left_join(toka_c_points %>% select(`2018`, change18, change21) %>% rownames_to_column(), by = "rowname") %>% 
  column_to_rownames("rowname") %>% 
  mutate(negative = pathotroph + saprotroph + pathotroph_saprotroph)

functional_totals = rowSums(fungal_func_sum) %>% 
  as.data.frame() %>% 
  clean_names() %>% 
  summarise(mean = mean(x), min = min(x), max = max(x))

trophic_averages = colMeans(fungal_func_sum) %>% 
  as.data.frame()

```




### models surface


#### symbiotroph
```{r}
surface_symbiotroph_current = lm(`2018` ~ symbiotroph, data = fung_carbon_10)
summary(surface_symbiotroph_current)

surface_symbiotroph_recent = lm(change18 ~ symbiotroph, data = fung_carbon_10)
summary(surface_symbiotroph_recent)

surface_symbiotroph_future = lm(change21 ~ symbiotroph, data = fung_carbon_10)
summary(surface_symbiotroph_future)

```


#### s-s
```{r}
surface_saprotroph_symbiotroph_current = lm(`2018` ~ saprotroph_symbiotroph, data = fung_carbon_10)
summary(surface_saprotroph_symbiotroph_current)

surface_saprotroph_symbiotroph_recent = lm(change18 ~ saprotroph_symbiotroph, data = fung_carbon_10)
summary(surface_saprotroph_symbiotroph_recent)

surface_saprotroph_symbiotroph_future = lm(change21 ~ saprotroph_symbiotroph, data = fung_carbon_10)
summary(surface_saprotroph_symbiotroph_future)

```
#### pathotroph

```{r}
surface_pathotroph_current = lm(`2018` ~ pathotroph, data = fung_carbon_10)
summary(surface_pathotroph_current)

surface_pathotroph_recent = lm(change18 ~ pathotroph, data = fung_carbon_10)
summary(surface_pathotroph_recent)

surface_pathotroph_future = lm(change21 ~ pathotroph, data = fung_carbon_10)
summary(surface_pathotroph_future)

```
#### saprotroph

```{r}
surface_saprotroph_current = lm(`2018` ~ saprotroph, data = fung_carbon_10)
summary(surface_saprotroph_current)

surface_saprotroph_recent = lm(change18 ~ saprotroph, data = fung_carbon_10)
summary(surface_saprotroph_recent)

surface_saprotroph_future = lm(change21 ~ saprotroph, data = fung_carbon_10)
summary(surface_saprotroph_future)

plot(surface_saprotroph_future)

```

```{r}
surface_negative_current = lm(`2018` ~ negative, data = fung_carbon_10)
summary(surface_negative_current)

surface_negative_recent = lm(change18 ~ negative, data = fung_carbon_10)
summary(surface_negative_recent)

surface_negative_future = lm(change21 ~ negative, data = fung_carbon_10)
summary(surface_negative_future)

```

### models Depth

#### symbiotroph
```{r}
depth_symbiotroph_current = lm(`2018` ~ symbiotroph, data = fung_carbon_40)
summary(depth_symbiotroph_current)

depth_symbiotroph_recent = lm(change18 ~ symbiotroph, data = fung_carbon_40)
summary(depth_symbiotroph_recent)

depth_symbiotroph_future = lm(change21 ~ symbiotroph, data = fung_carbon_40)
summary(depth_symbiotroph_future)

```
#### pathotroph

```{r}
depth_pathotroph_current = lm(`2018` ~ pathotroph, data = fung_carbon_40)
summary(depth_pathotroph_current)

depth_pathotroph_recent = lm(change18 ~ pathotroph, data = fung_carbon_40)
summary(depth_pathotroph_recent)

depth_pathotroph_future = lm(change21 ~ pathotroph, data = fung_carbon_40)
summary(depth_pathotroph_future)

```

#### s-s
```{r}
depth_saprotroph_symbiotroph_current = lm(`2018` ~ saprotroph_symbiotroph, data = fung_carbon_40)
summary(depth_saprotroph_symbiotroph_current)

depth_saprotroph_symbiotroph_recent = lm(change18 ~ saprotroph_symbiotroph, data = fung_carbon_40)
summary(depth_saprotroph_symbiotroph_recent)

depth_saprotroph_symbiotroph_future = lm(change21 ~ saprotroph_symbiotroph, data = fung_carbon_40)
summary(depth_saprotroph_symbiotroph_future)

```
#### saprotroph

```{r}
depth_saprotroph_current = lm(`2018` ~ saprotroph, data = fung_carbon_40)
summary(depth_saprotroph_current)

depth_saprotroph_recent = lm(change18 ~ saprotroph, data = fung_carbon_40)
summary(depth_saprotroph_recent)

depth_saprotroph_future = lm(change21 ~ saprotroph, data = fung_carbon_40)
summary(depth_saprotroph_future)

```

#### Aggregate groups

```{r}
surface_negative_current = lm(`2018` ~ negative, data = fung_carbon_40)
summary(surface_negative_current)

surface_negative_recent = lm(change18 ~ negative, data = fung_carbon_40)
summary(surface_negative_recent)

surface_negative_future = lm(change21 ~ negative, data = fung_carbon_40)
summary(surface_negative_future)

```

### Plots

```{r}
(saprotroph_plot = ggplot(fung_carbon, aes(x = saprotroph, y = change21)) +
  geom_point() +
  facet_wrap(. ~ depth_text) +
  theme_bw() +
  facet_grid(. ~ depth_text) +
  theme(axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill="white")) +
  geom_smooth(method = "lm", color = "black", linetype = "dashed") +
  ylab("% Organic Carbon") +
  xlab("Saprotroph Relative Abundance"))


ggsave(here::here("documents/figures/saprotroph_plot.png"), dpi = 300, plot = saprotroph_plot, device = "png", width = 8, height = 6)

```

